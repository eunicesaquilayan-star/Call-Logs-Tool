<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Call Logs Tool</title>

<!-- Favicon (prevents 404 error) -->
<link rel="icon" href="data:,">

<!-- Firebase COMPAT -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#f4f6f9;
  --card:#fff;
  --primary:#5b2be0;
  }
  .sla-ok {
  color: #2e7d32;
  font-weight: bold;
}

.sla-warning {
  color: #d32f2f;
  font-weight: bold;
}

.sla-breached {
  color: #b71c1c;
  font-weight: bold;

}
.toast{
  position:fixed;
  top:20px;
  right:20px;
  background:#5b2be0;
  color:#fff;
  padding:12px 18px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,.2);
  z-index:9999;
  opacity:0;
  transform:translateY(-20px);
  pointer-events:none;
  transition:opacity .4s ease, transform .4s ease;
}
.toast.show{
  opacity:1;
  transform:translateY(0);
}
body{margin:0;font-family:Arial;background:var(--bg)}
header{display:none;justify-content:space-between;align-items:center;padding:10px 20px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.container{max-width:1200px;margin:auto;padding:20px}
.card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);margin-bottom:20px}
input,select,textarea{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc}
.primary{background:var(--primary);color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer}
.logout{background:#666;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #ddd;font-size:13px;text-align:left}
.hidden{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
.modal-content{background:#fff;padding:20px;border-radius:10px;max-width:500px;width:90%}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="container">
  <div class="card" style="max-width:420px;margin:auto;text-align:center">
    <img src="./images/SL-Logo5.png" height="95">
    <h2>Login</h2>
    <input id="loginEmail" type="email" placeholder="name@supplylogic.com">
    <input id="loginPassword" type="password" placeholder="Password">
    <button class="primary" onclick="login()">Login</button>
  </div>
</div>

<!-- HEADER -->
<header id="appHeader">
  <img src="./images/SL-Logo4.png" height="95">
  <div>
    <span id="userEmail"></span>
    <button class="logout" onclick="logout()">Logout</button>
  </div>
</header>

<!-- APP -->
<div id="app" class="container hidden">

  <!-- AGENT FORM -->
  <div id="agentForm" class="card">
    <h3>New Call Log</h3>
    <input id="customer" placeholder="Customer Name">
    <input id="phone" placeholder="Phone Number">
    <input id="refId" placeholder="User ID / Order # / INV #">
    <select id="tool" onchange="loadCompanies()">
      <option value="">Select Tool</option>
      <option>Shopify</option>
      <option>Marcom</option>
      <option>Marketing Bench</option>
    </select>
    <select id="company"></select>
    <select id="disposition" onchange="checkDispositionReason()">
  <option>Password Reset</option>
  <option>Order Entry</option>
  <option>Order Status/ Tracking</option>
  <option>Impersonate</option>
  <option>Other Department</option>
  <option>Refer to AM</option>
</select>
    <select id="amReason" class="hidden">
  <option value="">Select AM Reason</option>
  <option>Account creation</option>
  <option>Account transfer to a new manager, director, etc</option>
  <option>Back order</option>
  <option>Inventory</option>
  <option>Order Pending</option>
  <option>Order Approval</option>
  <option>Website update</option>
  <option>Other</option>
</select>

    <select id="status">
      <option>Open</option>
      <option>Follow-up</option>
      <option>Resolved</option>
    </select>
    <textarea id="notes" rows="6">Concern:

Action Taken:</textarea>
    <button class="primary" onclick="saveLog()">Submit Log</button>
  </div>
  
  <!-- AGENT DAILY STATS -->
  <div class="card">
    <h3>My Daily Stats</h3>
    <input type="date" id="agentDay">
    <button class="primary" onclick="loadAgentStats()">View</button>
    <div id="agentStats"></div>
  </div>

  <!-- AGENT HISTORY -->
  <div class="card">
    <h3>History</h3>
    <input type="text" id="searchCustomer" placeholder="Search by Customer">
    <select id="filterCompany"></select>
    <input type="date" id="filterStartDate">
    <input type="date" id="filterEndDate">
    <button class="primary" onclick="loadLogs()">Search / Filter</button>
    <table>
      <thead>
       <tr>
  <th>Customer</th>
  <th>Phone</th>
  <th>Company</th>
  <th>Disposition</th>
  <th>Status</th>
  <th>Agent</th>
  <th>Date</th>
  <th>SLA</th>
  <th>Notes</th>
  <th></th>
</tr>

      </thead>
      <tbody id="logTable"></tbody>
    </table>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="card hidden">
    <h3>Admin Analytics</h3>
    <select id="adminCompanyFilter"></select>
    <input type="date" id="adminStartDate">
    <input type="date" id="adminEndDate">
    <button class="primary" onclick="loadAdminAnalytics()">Run Analytics</button>
    <hr>
    <div id="leaderboard"></div>
    <div id="analytics"></div>
    <button class="primary" onclick="exportCSV()">Export CSV</button>
  </div>

</div>

<!-- NOTES MODAL -->
<div id="notesModal" class="modal">
  <div class="modal-content">
    <div id="modalText"></div>
    <button class="primary" onclick="closeModal()">Close</button>
  </div>
</div>

<div id="actionToast" class="toast"></div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBEbq_d9nGXFLNdHaWICDfOzvQECC6yjOQ",
  authDomain:"call-logs-tool.firebaseapp.com",
  projectId:"call-logs-tool"
});
const auth=firebase.auth();
const db=firebase.firestore();
let isAdmin=false;

// LOGIN
function login(){
  const email = loginEmail.value.trim();
  if(!email.endsWith('@supplylogic.com')) return alert('Only @supplylogic.com allowed');
  auth.signInWithEmailAndPassword(email,loginPassword.value).catch(e=>alert(e.message));
}

// ENTER KEY HANDLING (FIXED)
document.addEventListener('keydown', e=>{
  if(e.key !== 'Enter') return;

  // LOGIN PAGE ONLY
  if(!document.getElementById('loginPage').classList.contains('hidden')){
    login();
    return; // stop here
  }

  // PREVENT submit while typing notes
  if(document.activeElement.tagName === 'TEXTAREA') return;

  // APP PAGE ONLY
  if(!document.getElementById('app').classList.contains('hidden')){
    saveLog();
  }
});

// LOGOUT
function logout(){
  stopSlaAutoRefresh();
  auth.signOut();
}

// AUTH STATE
auth.onAuthStateChanged(u=>{
  if(u){
    showToast('✅ Login successful',2000);
    isAdmin = u.email.startsWith('admin');
    loginPage.classList.add('hidden');
    app.classList.remove('hidden');
    appHeader.style.display='flex';
    userEmail.textContent = u.email;

    if(isAdmin){
      adminPanel.classList.remove('hidden');
      agentForm.classList.add('hidden');
      document.querySelector('#agentDay').closest('.card').classList.add('hidden');
      loadAdminCompanies();
    }
    loadLogs();
    startSlaAutoRefresh();

  } else {
    loginPage.classList.remove('hidden');
    app.classList.add('hidden');
    appHeader.style.display='none';
  }
});

// COMPANIES
const companies={
  "Shopify":[
    "Bayada Wear","First Watch Shop","First Watch Swag","KOC","Learfield",
    "Raising Cane's Gear","Sevita","The Home Homer",
    "Dave & Buster's","Premise Health"
  ],
  "Marcom":[
    "American Airlines Credit Union","Applebee's","Brinker","Cash America",
    "Choice Hotels","Dave & Buster's / Main Event","Denny's",
    "Fogo de Chao","IHOP","Noodles & Company","Pei Wei",
    "Pizza Hut","Steak N Shake"
  ],
  "Marketing Bench":[
    "23 Restaurant Services","Aaron's, Inc.","Access Marketing Services","AdventHealth",
    "Agora Marketing Solutions, Inc.","Altium Packaging","AmeriHealth Caritas Services, LLC",
    "Arvest Bank","Baltimore Ravens","Baptist Memorial Health Care Corp",
    "BBI / Outback","Bonefish Grill","Brightview Senior Living","CACI","Cambria Properties",
    "CareFirst Management Company LLC","Carelon Behavioral Health","CarMax",
    "Carrabba's Italian Grill","Chicken Salad Chick","CIS-Knights of Columbus",
    "Compupay","Constellation Energy Generation LLC","Cumberland Pharmaceuticals",
    "D.R. Horton","Delaware North","DS Services of America, Inc.","Equistar Chemicals, LP",
    "Essential Brands dba/Kiddie Academy","First Busey Corporation","First Command",
    "First Watch Restaurants","Fleming's","Fraternal-Knights of Columbus","Georgia Power",
    "Hampton Inn & Suites - Hilton WW","HGI-Food & Beverage","Hilton Brands marKIT Orders",
    "Hilton F&B","HughesNet","Inventory/Coupa-Knights of Columbus",
    "James Hardie Bldg Products","Johns Manville","Keolis Transit America, Inc.",
    "Keplr Vision","KeyBank-WHS","La Quinta by Wyndham Hotels&Resorts",
    "Learfield Communications, LLC","LHC Group, Inc.","LYB Company Store","M&T Bank",
    "MAA Open Arms Program","Magellan Health","Magellan MFLC","Medstar Health",
    "Merry Maids","MileOne Autogroup","Modivcare","Natl. Mentor DBA Sevita",
    "NVR Marketing Services","Paycom Payroll Holdings","Piedmont Healthcare",
    "Pinch A Penny, Inc","Populus Fin. Group DBA ACE Cash Exp",
    "Preferred Hotel Group","Premise Health","Printpack","Qiagen",
    "SAIA Motor Freight Line, LLC","Sales Resource Center","Sick, Inc",
    "Southern Company Gas","Spanish site-Knights of Columbus",
    "Specialty Dental Brands","SSP America","Taub Family Selections",
    "Test Account Training","The Villages Operating Company","Transwestern",
    "Triad Advertising Corp","Trillium Health Resources","UMROI","Under Armour",
    "University of MD Medical System","Webb Mason Commercial",
    "Webb/Mason Company Store","Westmoor Mfg Co",
    "Wyndham Hotels&Resorts, Inc.","Yokohama Off Highway Tires"
  ]
};

function loadCompanies() {
  const toolEl = document.getElementById('tool');
  const companyEl = document.getElementById('company');
  const tool = toolEl.value;

  companyEl.innerHTML = '<option value="">Select Company</option>'; // reset

  if (!tool || !companies[tool]) return; // nothing selected

  companies[tool].forEach(c => {
    const o = document.createElement('option');
    o.value = o.textContent = c;
    companyEl.appendChild(o);
  });
}
function checkDispositionReason(){
  const disp = document.getElementById('disposition').value;
  const amBox = document.getElementById('amReason');

  if(disp === 'Refer to AM'){
    amBox.classList.remove('hidden');
  } else {
    amBox.classList.add('hidden');
    amBox.value='';
  }
}


// SAVE LOG
function saveLog(){
  const customerEl = document.getElementById('customer');
  const phoneEl = document.getElementById('phone');
  const refEl = document.getElementById('refId');
  const toolEl = document.getElementById('tool');
  const companyEl = document.getElementById('company');
  const dispositionEl = document.getElementById('disposition');
  const statusEl = document.getElementById('status');
  const notesEl = document.getElementById('notes');

  if(!customerEl.value || !toolEl.value || !companyEl.value) return alert('Please complete required fields');

  db.collection('logs').add({
    customer: customerEl.value,
    phone: phoneEl.value||'',
    ref: refEl.value||'',
    tool: toolEl.value,
    company: companyEl.value,
    disposition: dispositionEl.value||'',
    amReason: document.getElementById('amReason').value || '',
    status: statusEl.value||'Open',
    notes: notesEl.value.trim(),
    agent: auth.currentUser.email,
    created: firebase.firestore.FieldValue.serverTimestamp(),
    createdDay: new Date().toISOString().slice(0,10),
    createdMonth: new Date().toISOString().slice(0,7),
      
     // ✅ SLA FIELDS
  slaHours: (statusEl.value === 'Resolved') ? 0 : 48,
  slaStatus: (statusEl.value === 'Resolved') ? 'Resolved On Time' : 'Open'
  }).then(()=>{
    customerEl.value=''; phoneEl.value=''; refEl.value=''; notesEl.value="Concern:\n\n\nAction Taken:";
    showToast("✅ Log saved successfully");
    loadLogs();
  }).catch(e=>alert(e.message));
}

// SHOW TOAST
function showToast(msg,duration=2500){
  const t=document.getElementById('actionToast'); t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),duration);
}

// POPULATE FILTERS
function populateCompanyFilter(){
  const companySelect=document.getElementById('filterCompany');
  companySelect.innerHTML='<option value="">All Companies</option>';
  const allCompanies=[].concat(...Object.values(companies));
  allCompanies.forEach(c=>{
    const o=document.createElement('option'); o.value=o.textContent=c; companySelect.appendChild(o);
  });
}
populateCompanyFilter();

// LOAD LOGS (AGENT) — WITH SLA TRACKING
function loadLogs(){
  const table = document.getElementById('logTable');
  table.innerHTML = '';

  let q = db.collection('logs').orderBy('created','desc');

  const customerSearch = document.getElementById('searchCustomer').value.trim().toLowerCase();
  const companyFilter = document.getElementById('filterCompany').value;
  const startDate = document.getElementById('filterStartDate').value;
  const endDate = document.getElementById('filterEndDate').value;

  if(companyFilter) q = q.where('company','==',companyFilter);
  if(startDate) q = q.where('createdDay','>=',startDate);
  if(endDate) q = q.where('createdDay','<=',endDate);

  q.get().then(s=>{
    s.forEach(d=>{
      const l = d.data();

      // CUSTOMER SEARCH FILTER
      if(customerSearch && !l.customer.toLowerCase().includes(customerSearch)) return;

      // ===== SLA COMPUTATION (COUNTDOWN) =====
const created = l.created?.toDate();
let slaText = '—';
let slaClass = '';

if (created && l.status !== 'Resolved') {
  const SLA_HOURS = 48;
  const elapsedMs = Date.now() - created.getTime();
  const elapsedHours = elapsedMs / 36e5;
  const remainingHours = SLA_HOURS - elapsedHours;

  if (remainingHours <= 0) {
    const over = Math.abs(remainingHours);
    const h = Math.floor(over);
    const m = Math.floor((over - h) * 60);
    slaText = `❌ Breached by ${h}h ${m}m`;
    slaClass = 'sla-breached';
  }
  else {
    const h = Math.floor(remainingHours);
    const m = Math.floor((remainingHours - h) * 60);

    if (remainingHours <= 8) {
      slaText = `⚠️ ${h}h ${m}m remaining`;
      slaClass = 'sla-warning';
    } else {
      slaText = `⏳ ${h}h ${m}m remaining`;
      slaClass = 'sla-ok';
    }
  }
}

if (l.status === 'Resolved') {
  slaText = '✅ Resolved';
  slaClass = 'sla-ok';
}



      // ===== BUILD ROW =====
      const tr = document.createElement('tr');
if (someCondition) {
  tr.style.backgroundColor = '#eee';
}
    

      tr.innerHTML = `
<td>${l.customer}</td>
<td>${l.phone}</td>
<td>${l.company}</td>
<td>${l.disposition}</td>
<td>${l.status}</td>
<td>${l.agent}</td>
<td>${l.created?.toDate().toLocaleString() || ''}</td>
<td><span class="${slaClass}">${slaText}</span></td>
<td><button onclick="viewNotes('${d.id}')">View</button></td>
<td>${isAdmin ? `<button onclick="deleteLog('${d.id}')">Delete</button>` : ''}</td>
      `;

      table.appendChild(tr);
    });
  });
}


// VIEW NOTES MODAL
function viewNotes(id){
  const modalText = document.getElementById('modalText');
  const notesModal = document.getElementById('notesModal');

  db.collection('logs').doc(id).get().then(doc => {
    if (!doc.exists) return;

    const notes = doc.data().notes || "";
    const [concernPart, actionPart] = notes.split("Action Taken:");

    modalText.innerHTML = `
      <b>Concern</b><br><br>
      ${concernPart ? concernPart.replace("Concern:", "").trim() : ''}
      <br><br>
      <b>Action Taken</b><br><br>
      ${actionPart ? actionPart.trim() : ''}
    `;

    notesModal.style.display = 'flex';
  }).catch(e => {
    alert("Error loading notes: " + e.message);
  });
}

// CLOSE NOTES MODAL
function closeModal(){
  const notesModal = document.getElementById('notesModal');
  notesModal.style.display = 'none';
}


// EXPORT CSV
function exportCSV(){
  db.collection('logs').get().then(s=>{
    let csv="Customer,Phone,Company,Disposition,AM Reason,Status,SLA Status,Agent,Date,Notes\n";

    s.forEach(d=>{
      const l=d.data();
      const created=l.created?.toDate();
      const hours=created ? (Date.now()-created.getTime())/36e5 : 0;

      let sla='On Time';
      if(l.status!=='Resolved' && hours>48) sla='BREACHED';

      csv+=`${l.customer},${l.phone},${l.company},${l.disposition},${l.amReason||''},${l.status},${sla},${l.agent},${created||''},"${l.notes.replace(/\n/g,' ')}"\n`;
    });

    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download='call_logs_sla_report.csv';
    a.click();
  });
}


// AGENT DAILY STATS
function loadAgentStats(){
  const day=document.getElementById('agentDay').value;
  if(!day) return alert('Select a date');
  db.collection('logs').where('agent','==',auth.currentUser.email).where('createdDay','==',day).get().then(s=>{
    let total=0,res=0;
    s.forEach(d=>{ total++; if(d.data().status==='Resolved') res++; });
    agentStats.innerHTML=`<b>Total Logs:</b> ${total}<br><b>Resolved:</b> ${res}`;
  });
}

// ADMIN ANALYTICS
function loadAdminAnalytics(){
  let q=db.collection('logs');

  const company=document.getElementById('adminCompanyFilter').value;
  const start=document.getElementById('adminStartDate').value;
  const end=document.getElementById('adminEndDate').value;

  if(company) q=q.where('company','==',company);
  if(start) q=q.where('createdDay','>=',start);
  if(end) q=q.where('createdDay','<=',end);

  q.get().then(s=>{
    const agentStats={}, dispositionStats={}, slaDispStats={};
    let resolvedOnTime=0, breached=0, openBreached=0;

    s.forEach(d=>{
      const l=d.data();
      const created=l.created?.toDate();
      const hours=created ? (Date.now()-created.getTime())/36e5 : 0;

      // Leaderboard
      if(!agentStats[l.agent]) agentStats[l.agent]={logs:0,resolved:0};
      agentStats[l.agent].logs++;
      if(l.status==='Resolved') agentStats[l.agent].resolved++;

      // Disposition usage
      dispositionStats[l.disposition]=(dispositionStats[l.disposition]||0)+1;

      // SLA tracking
      if(l.status==='Resolved' && hours<=48) resolvedOnTime++;
      if(hours>48){
        breached++;
        slaDispStats[l.disposition]=(slaDispStats[l.disposition]||0)+1;
        if(l.status!=='Resolved') openBreached++;
      }
    });

    // Leaderboard
    let lb=`<h4>Agent Activity Leaderboard</h4>
    <table><tr><th>Agent</th><th>Logs</th><th>Resolved</th><th>%</th></tr>`;

    Object.entries(agentStats)
    .sort((a,b)=>b[1].logs-a[1].logs)
    .forEach(([a,v])=>{
      const pct=((v.resolved/v.logs)*100||0).toFixed(1);
      lb+=`<tr><td>${a}</td><td>${v.logs}</td><td>${v.resolved}</td><td>${pct}%</td></tr>`;
    });

    lb+='</table>';
    leaderboard.innerHTML=lb;

    // SLA Analytics
    analytics.innerHTML=`
<h4>SLA REPORT</h4>
Resolved On Time: ${resolvedOnTime}<br>
Breached: ${breached}<br>
Open / Follow-up Breached: ${openBreached}

<h4 style="margin-top:15px">Disposition Causing Breaches</h4>
${Object.entries(slaDispStats).map(d=>`${d[0]}: ${d[1]}`).join('<br>')}
`;
  });
}
// ===== AUTO REFRESH SLA EVERY MINUTE =====
let slaAutoRefresh = null;

function startSlaAutoRefresh() {
  if (slaAutoRefresh) return; // prevent duplicates
  slaAutoRefresh = setInterval(() => {
    if (!document.getElementById('app').classList.contains('hidden')) {
      loadLogs();
    }
  }, 60000);
}

function stopSlaAutoRefresh() {
  if (slaAutoRefresh) {
    clearInterval(slaAutoRefresh);
    slaAutoRefresh = null;
  }
}

</script>

</body>
</html>








