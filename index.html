<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Call Logs Tool</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root{
 --bg:#f4f6f9;--card:#fff;--text:#212529;--border:#dee2e6;--primary:#0d6efd
}
body.dark{
 --bg:#121212;--card:#1e1e1e;--text:#e9ecef;--border:#2a2a2a
}
body{font-family:Arial;background:var(--bg);color:var(--text);margin:0}
.container{max-width:1600px;margin:30px auto;background:var(--card);padding:30px;border-radius:12px}
header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--border);padding-bottom:15px}
button{background:var(--primary);color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer}
input,select,textarea{width:100%;padding:10px;margin-bottom:12px;border-radius:6px;border:1px solid var(--border)}
textarea{min-height:180px}
.hidden{display:none}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid var(--border);padding:10px;font-size:14px}
.preview{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
.badge{padding:4px 8px;border-radius:6px;background:#198754;color:#fff;font-size:12px}
.filters{display:flex;gap:10px;margin:15px 0}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px}
.stat{background:#eef2ff;padding:15px;border-radius:10px}
</style>
</head>

<body>

<div class="container">

<header>
 <img src="./images/SL-Logo4.png" height="90">
 <div>
  <button onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
  <button id="logoutBtn" class="hidden" onclick="logout()">Logout</button>
 </div>
</header>

<!-- LOGIN -->
<div id="loginSection">
 <h3>Login</h3>
 <input id="email" placeholder="Email">
 <input id="password" type="password" placeholder="Admin Password (admins only)">
 <button onclick="login()">Login</button>
</div>

<!-- AGENT -->
<div id="agentSection" class="hidden">

<h3>New Call Log</h3>

<select id="tool" onchange="loadCompanies()">
 <option value="">Select Tool *</option>
 <option value="Shopify">Shopify</option>
 <option value="Marcom">Marcom</option>
 <option value="Marketing Bench">Marketing Bench</option>
</select>

<select id="company" disabled>
 <option value="">Select Company *</option>
</select>

<input id="name" placeholder="Customer Name">
<input id="phone" placeholder="Phone">
<input id="ref" placeholder="User ID / Order # / Inv #">

<select id="disposition">
 <option value="">Disposition *</option>
 <option>Password Reset</option>
 <option>Order Entry</option>
 <option>Order Status</option>
 <option>General Inquiry</option>
</select>

<select id="status">
 <option value="Open">Open</option>
 <option value="Follow Up">Follow Up</option>
 <option value="Resolved">Resolved</option>
</select>

<textarea id="notes">CONCERN:

ACTION TAKEN:</textarea>

<button onclick="submitLog()">Submit Log</button>

<h4>My History</h4>

<div class="filters">
 <select id="filterCompany"></select>
 <input type="date" id="filterDate">
 <button onclick="loadAgentLogs()">Filter</button>
</div>

<table>
<thead>
<tr>
<th>Customer</th>
<th>Company</th>
<th>Disposition</th>
<th>Status</th>
<th>Notes</th>
<th>Date</th>
</tr>
</thead>
<tbody id="agentLogs"></tbody>
</table>

</div>

<!-- ADMIN -->
<div id="adminSection" class="hidden">

<h3>Admin Dashboard</h3>

<div class="stats">
 <div class="stat" id="statAgents"></div>
 <div class="stat" id="statCompany"></div>
 <div class="stat" id="statDisposition"></div>
 <div class="stat" id="statResolved"></div>
</div>

<button onclick="exportCSV()">‚¨á Export CSV</button>

</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBEbq_d9nGXFLNdHaWICDfOzvQECC6yjOQ",
  authDomain: "call-logs-tool.firebaseapp.com",
  projectId: "call-logs-tool"
});
const db = firebase.firestore();
const auth = firebase.auth();

/* AUTH */
auth.signInAnonymously();

/* STATE */
let user = sessionStorage.getItem("user") || "";
let isAdmin = false;
let startTime = Date.now();

/* LOGIN */
function login(){
 const email = email.value = document.getElementById("email").value.trim();
 const pass = document.getElementById("password").value;

 if(!email) return alert("Email required");

 user = email;
 sessionStorage.setItem("user", user);

 if(pass === "SL@123"){
   isAdmin = true;
   adminSection.classList.remove("hidden");
   agentSection.classList.add("hidden");
   loadAdminStats();
 } else {
   agentSection.classList.remove("hidden");
   adminSection.classList.add("hidden");
   loadAgentLogs();
 }

 loginSection.classList.add("hidden");
 logoutBtn.classList.remove("hidden");
}

/* LOGOUT */
function logout(){
 sessionStorage.clear();
 location.reload();
}

function toggleTheme(){ document.body.classList.toggle("dark"); }

/* TOOL ‚Üí COMPANY */
const companyMap={
 Shopify:["Bayada Wear","First Watch Shop","First Watch Swag"],
 Marcom:["Cash America","Choice Hotels","Dave & Buster's / Main Event"],
 "Marketing Bench":["23 Restaurant Services","Aaron's, Inc.","Access Marketing Services"]
};

function loadCompanies(){
 company.innerHTML='<option value="">Select Company *</option>';
 (companyMap[tool.value]||[]).forEach(c=>{
  company.innerHTML+=`<option>${c}</option>`;
 });
}

/* SUBMIT */
async function submitLog(){
 if(!tool.value||!company.value||!disposition.value) return alert("Complete required fields");

 await db.collection("logs").add({
  agent:user,
  customer:name.value,
  company:company.value,
  disposition:disposition.value,
  status:status.value,
  notes:notes.value,
  created:firebase.firestore.FieldValue.serverTimestamp()
 });

 /* CLEAR FIELDS */
 name.value=phone.value=ref.value="";
 disposition.value="";
 status.value="Open";
 notes.value="CONCERN:\n\nACTION TAKEN:";
 startTime=Date.now();

 loadAgentLogs();
}

/* AGENT HISTORY */
function loadAgentLogs(){
 agentLogs.innerHTML="";
 db.collection("logs")
 .where("agent","==",user)
 .orderBy("created","desc")
 .get()
 .then(s=>{
  s.forEach(d=>{
   const x=d.data();
   agentLogs.innerHTML+=`
    <tr>
     <td>${x.customer||""}</td>
     <td>${x.company}</td>
     <td>${x.disposition}</td>
     <td>${x.status}</td>
     <td class="preview">${x.notes||""}</td>
     <td>${x.created?x.created.toDate().toLocaleString():""}</td>
    </tr>`;
  });
 });
}

/* ADMIN ANALYTICS */
function loadAdminStats(){
 db.collection("logs").get().then(s=>{
  let agents={},company={},disp={},res=0;
  s.forEach(d=>{
   const x=d.data();
   agents[x.agent]=(agents[x.agent]||0)+1;
   company[x.company]=(company[x.company]||0)+1;
   disp[x.disposition]=(disp[x.disposition]||0)+1;
   if(x.status==="Resolved") res++;
  });
  statAgents.innerHTML="<b>Logs / Agent</b><br>"+Object.entries(agents).map(x=>`${x[0]}: ${x[1]}`).join("<br>");
  statCompany.innerHTML="<b>Top Company</b><br>"+Object.entries(company).sort((a,b)=>b[1]-a[1])[0];
  statDisposition.innerHTML="<b>Top Disposition</b><br>"+Object.entries(disp).sort((a,b)=>b[1]-a[1])[0];
  statResolved.innerHTML=`<b>Resolved</b><br>${res} / ${s.size} (${((res/s.size)*100).toFixed(1)}%)`;
 });
}

/* EXPORT */
function exportCSV(){
 db.collection("logs").get().then(s=>{
  let csv="Agent,Customer,Company,Disposition,Status,Notes,Date\n";
  s.forEach(d=>{
   const x=d.data();
   csv+=`${x.agent},${x.customer||""},${x.company},${x.disposition},${x.status},"${(x.notes||"").replace(/"/g,'""')}",${x.created?.toDate()}\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="call_logs.csv";
  a.click();
 });
}
</script>
</body>
</html>
