<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Call Logs Tool</title>

  <!-- Firebase v9 -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #f4f6fa;
      --text: #111;
      --card: #fff;
      --primary: #2f6fed;
    }
    body.dark {
      --bg: #0f172a;
      --text: #e5e7eb;
      --card: #1e293b;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: var(--primary);
      color: #fff;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header img { height: 30px; }
    button { cursor: pointer; }
    .container { padding: 16px; }
    .card {
      background: var(--card);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
    }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #ccc; }
  </style>
</head>
<body>

<header>
  <img src="logo.png" alt="Logo" />
  <div>
    <span id="userEmail"></span>
    <button onclick="toggleDark()">üåô</button>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h2>Login</h2>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Admin password (optional)" />
    <button onclick="login()">Login</button>
  </div>

  <!-- LOG FORM -->
  <div id="logCard" class="card hidden">
    <h2>Submit Log</h2>

    <select id="tool">
      <option value="">Select Tool</option>
      <option>Shopify</option>
      <option>Marcom</option>
      <option>Marketing Bench</option>
    </select>

    <select id="company">
      <option value="">Select Company</option>
    </select>

    <input id="ref" placeholder="User ID / Order # / Inv #" />
    <input id="notes" placeholder="Notes" />

    <button onclick="submitLog()">Submit</button>
  </div>

  <!-- ADMIN -->
  <div id="adminCard" class="card hidden">
    <h2>Admin Dashboard</h2>

    <input type="date" id="fromDate" />
    <input type="date" id="toDate" />
    <button onclick="loadLogs()">Filter</button>

    <canvas id="chart"></canvas>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>User</th>
          <th>Tool</th>
          <th>Company</th>
          <th>Ref</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="logs"></tbody>
    </table>
  </div>

</div>

<script>
/******** FIREBASE CONFIG ********/
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
});
const db = firebase.firestore();

/******** STATE ********/
let isAdmin = false;

/******** LOGIN ********/
function login() {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value;

  if (!email) return alert('Email required');

  isAdmin = pass === 'admin123';
  sessionStorage.setItem('user', JSON.stringify({ email, isAdmin }));
  init();
}

function init() {
  const user = JSON.parse(sessionStorage.getItem('user'));
  if (!user) return;

  document.getElementById('userEmail').textContent = user.email;
  document.getElementById('loginCard').classList.add('hidden');
  document.getElementById('logCard').classList.remove('hidden');

  if (user.isAdmin) {
    document.getElementById('adminCard').classList.remove('hidden');
    loadLogs();
  }
}

function logout() {
  sessionStorage.clear();
  location.reload();
}

/******** DARK MODE ********/
function toggleDark() {
  document.body.classList.toggle('dark');
}

/******** DROPDOWNS ********/
const companyMap = {
  Shopify: ['Bayada Wear', 'First Watch Shop', 'First Watch Swag'],
  Marcom: ['Cash America', 'Choice Hotels', "Dave & Buster's / Main Event"],
  'Marketing Bench': ['23 Restaurant Services', "Aaron's, Inc.", 'Access Marketing Services']
};

document.getElementById('tool').addEventListener('change', e => {
  const company = document.getElementById('company');
  company.innerHTML = '<option value="">Select Company</option>';
  (companyMap[e.target.value] || []).forEach(c => {
    const o = document.createElement('option');
    o.textContent = c;
    o.value = c;
    company.appendChild(o);
  });
});

/******** SUBMIT LOG ********/
async function submitLog() {
  const user = JSON.parse(sessionStorage.getItem('user'));
  if (!user) return alert('Not logged in');

  const data = {
    tool: document.getElementById('tool').value,
    company: document.getElementById('company').value,
    ref: document.getElementById('ref').value,
    notes: document.getElementById('notes').value,
    email: user.email,
    createdAt: firebase.firestore.Timestamp.now()
  };

  if (!data.tool || !data.company) return alert('Missing fields');

  await db.collection('logs').add(data);
  alert('Saved');
}

/******** LOAD LOGS ********/
let chart;
async function loadLogs() {
  const snap = await db.collection('logs').orderBy('createdAt', 'desc').get();
  const tbody = document.getElementById('logs');
  tbody.innerHTML = '';

  const counts = {};

  snap.forEach(doc => {
    const d = doc.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.createdAt.toDate().toLocaleString()}</td>
      <td>${d.email}</td>
      <td>${d.tool}</td>
      <td>${d.company}</td>
      <td>${d.ref || ''}</td>
      <td>${d.notes || ''}</td>
      <td><button onclick="del('${doc.id}')">‚ùå</button></td>`;
    tbody.appendChild(tr);

    counts[d.tool] = (counts[d.tool] || 0) + 1;
  });

  renderChart(counts);
}

function del(id) {
  if (confirm('Delete?')) db.collection('logs').doc(id).delete().then(loadLogs);
}

/******** CHART ********/
function renderChart(data) {
  const ctx = document.getElementById('chart');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(data),
      datasets: [{ data: Object.values(data) }]
    }
  });
}

/******** INIT ********/
init();
</script>

</body>
</html>
