<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Call Log Tool (Multi-Agent)</title>

<!-- Firebase v9 COMPAT (correct for single HTML file) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
 --bg:#f4f6f9;--card:#fff;--text:#212529;--border:#dee2e6;--primary:#0d6efd
}
body.dark{
 --bg:#121212;--card:#1e1e1e;--text:#e9ecef;--border:#2a2a2a;--primary:#4dabf7
}
body{font-family:Arial;background:var(--bg);color:var(--text);margin:0}
.container{max-width:1400px;margin:30px auto;background:var(--card);padding:30px;border-radius:12px}
header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--border);padding-bottom:15px}
button{background:var(--primary);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer}
input,select,textarea{width:100%;padding:10px;margin:6px 0 14px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text)}
textarea{min-height:180px;white-space:pre-wrap}
.section{background:var(--bg);padding:20px;border-radius:10px;margin-bottom:30px}
.hidden{display:none}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--border);padding:10px}
th{background:var(--bg)}
.toggle{color:var(--primary);cursor:pointer;font-weight:bold}
.note-box{background:var(--bg);padding:15px;border-radius:6px;white-space:pre-wrap}
.badge{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:bold}
.open{background:#fff3cd}.resolved{background:#d1e7dd}.follow{background:#cfe2ff}
.admin{background:#fff3cd;padding:25px;border-radius:12px}
body.dark .admin{background:#2b250f}
.agent-badge{
 position:fixed;top:15px;right:20px;
 background:#0d6efd;color:white;
 padding:8px 14px;border-radius:20px;
 font-size:13px
}
</style>
</head>

<body>

<div id="agentBadge" class="agent-badge hidden"></div>

<div class="container">

<header>
  <img src="images/SL-Logo4.png" alt="SL Logo">
  <div>
    <button onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<div id="loginSection">
  <h3>Login</h3>
  <input id="loginEmail" placeholder="Agent Email">
  <input id="adminPassword" type="password" placeholder="Admin Password">
  <button onclick="login()">Login</button>
</div>

<div id="appSection" class="hidden">

<div class="section">
<h3>New Call Log</h3>

<input id="fullName" placeholder="Customer Name *">
<input id="phone" placeholder="Phone Number *">
<input id="refId" placeholder="User ID / Order # / Invoice #">

<select id="disposition">
  <option value="">Disposition *</option>
  <option>Password Reset</option>
  <option>Order Entry</option>
  <option>Order Status / Tracking</option>
  <option>General Inquiry</option>
</select>

<select id="status">
  <option>Open</option>
  <option>Follow Up</option>
  <option>Resolved</option>
</select>

<textarea id="notes">CONCERN:



ACTION TAKEN:</textarea>

<button onclick="addLog()">Submit Log</button>
</div>

<div class="section">
<h3>Search</h3>
<input id="search" placeholder="Search anything" onkeyup="renderLogs()">
</div>

<table>
<thead>
<tr>
<th>Name</th><th>Phone</th><th>ID</th>
<th>Disposition</th><th>Status</th><th>Notes</th><th>Agent</th><th>Date</th>
</tr>
</thead>
<tbody id="logTable"></tbody>
</table>

<div id="adminPanel" class="admin hidden">
<h3>Admin Dashboard</h3>
<canvas id="chart"></canvas>
</div>

</div>
</div>

<script>
/* ========= FIREBASE INIT ========= */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========= APP LOGIC ========= */
const ADMIN_PASSWORD = "rperez@123";
let currentUser = "";
let isAdmin = false;
let logsCache = [];
let chart;

function toggleTheme(){
 document.body.classList.toggle("dark");
}

function login(){
 if(!loginEmail.value) return alert("Email required");

 currentUser = loginEmail.value;
 isAdmin = adminPassword.value === ADMIN_PASSWORD;

 agentBadge.textContent = "Agent: " + currentUser;
 agentBadge.classList.remove("hidden");

 loginSection.classList.add("hidden");
 appSection.classList.remove("hidden");
 adminPanel.classList.toggle("hidden", !isAdmin);

 listenLogs();
}

function logout(){ location.reload(); }

async function addLog(){
 if(!fullName.value || !phone.value || !disposition.value)
   return alert("Missing required fields");

 await db.collection("logs").add({
   name: fullName.value,
   phone: phone.value,
   refId: refId.value,
   disposition: disposition.value,
   status: status.value,
   notes: notes.value,
   agent: currentUser,
   created: firebase.firestore.FieldValue.serverTimestamp(),
   day: new Date().toLocaleDateString()
 });

 notes.value = "CONCERN:\n\n\nACTION TAKEN:";
}

function listenLogs(){
 db.collection("logs").orderBy("created","desc")
 .onSnapshot(snap=>{
   logsCache = snap.docs.map(d=>({id:d.id,...d.data()}));
   renderLogs();
   if(isAdmin) renderChart();
 });
}

function renderLogs(){
 const q = search.value.toLowerCase();
 logTable.innerHTML = "";

 logsCache
 .filter(l => JSON.stringify(l).toLowerCase().includes(q))
 .forEach((l,i)=>{
   logTable.innerHTML += `
   <tr>
     <td>${l.name}</td>
     <td>${l.phone}</td>
     <td>${l.refId || ""}</td>
     <td>${l.disposition}</td>
     <td><span class="badge ${l.status==="Open"?"open":l.status==="Resolved"?"resolved":"follow"}">${l.status}</span></td>
     <td>
       <span class="toggle" onclick="document.getElementById('n${i}').classList.toggle('hidden')">View</span>
       <div id="n${i}" class="note-box hidden">${l.notes}</div>
     </td>
     <td>${l.agent}</td>
     <td>${l.created ? l.created.toDate().toLocaleString() : ""}</td>
   </tr>`;
 });
}

function renderChart(){
 const map = {};
 logsCache.forEach(l => map[l.day] = (map[l.day] || 0) + 1);

 if(chart) chart.destroy();
 chart = new Chart(chart, {
   type: "bar",
   data: {
     labels: Object.keys(map),
     datasets: [{ label: "Logs Per Day", data: Object.values(map) }]
   }
 });
}
</script>

</body>
</html>
