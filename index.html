<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Call Log Tool (Multi-Agent)</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
 --bg:#f4f6f9;--card:#fff;--text:#212529;--border:#dee2e6;--primary:#0d6efd
}
body.dark{
 --bg:#121212;--card:#1e1e1e;--text:#e9ecef;--border:#2a2a2a
}
body{font-family:Arial;background:var(--bg);color:var(--text);margin:0}
.container{max-width:1600px;margin:30px auto;background:var(--card);padding:30px;border-radius:12px}
header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--border);padding-bottom:15px}
button{background:var(--primary);color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer}
input,select,textarea{width:100%;padding:10px;margin:6px 0 14px;border-radius:6px;border:1px solid var(--border)}
textarea{min-height:220px}
.section{background:var(--bg);padding:20px;border-radius:10px;margin-bottom:30px}
.hidden{display:none}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--border);padding:10px}
.note-box{background:var(--card);padding:20px;border-radius:8px;white-space:pre-wrap}
.agent-badge{position:fixed;top:15px;right:20px;background:var(--primary);color:white;padding:8px 14px;border-radius:20px}
.stats{display:flex;gap:20px;margin-bottom:20px}
.stat{background:var(--card);padding:15px;border-radius:10px;border:1px solid var(--border)}
.filters{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:15px}
.admin{border:2px dashed var(--primary);padding:20px;border-radius:10px;margin-top:30px}
</style>
</head>

<body>

<div id="agentBadge" class="agent-badge hidden"></div>

<div class="container">

<header>
<img src="./images/SL-Logo4.png" height="95">
<div>
<button onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
<button id="logoutBtn" onclick="logout()" class="hidden">Logout</button>
</div>
</header>

<!-- LOGIN -->
<div id="loginSection">
<h3>Login</h3>
<input id="loginEmail" placeholder="Agent Email">
<button onclick="login()">Login</button>
</div>

<!-- APP -->
<div id="appSection" class="hidden">

<div class="stats">
<div class="stat">My Logs: <strong id="statTotal">0</strong></div>
<div class="stat">Resolved: <strong id="statResolved">0</strong></div>
<div class="stat">Open / Follow Up: <strong id="statOpen">0</strong></div>
</div>

<div class="section">
<h3>New Call Log</h3>

<select id="tool" onchange="loadCompanies()">
<option value="">Select Tool *</option>
<option>Shopify</option>
<option>Marcom</option>
<option>Marketing Bench</option>
</select>

<select id="company" disabled>
<option value="">Select Company *</option>
</select>

<input id="fullName" placeholder="Customer Name *">
<input id="phone" placeholder="Phone Number *">
<input id="refId" placeholder="User ID / Order # / Invoice # *">

<select id="disposition">
<option value="">Disposition *</option>
<option>Password Reset</option>
<option>Order Entry</option>
<option>Order Status / Tracking</option>
<option>General Inquiry</option>
</select>

<select id="status">
<option>Open</option>
<option>Follow Up</option>
<option>Resolved</option>
</select>

<textarea id="notes">
CONCERN:



ACTION TAKEN:
</textarea>

<button onclick="addLog()">Submit Log</button>
</div>

<div class="section">
<h3>Search & Filters</h3>
<div class="filters">
<input id="searchText" placeholder="Search anything">
<input id="filterCompany" placeholder="Company">
<input id="filterDate" type="date">
<select id="filterDisposition">
<option value="">All Dispositions</option>
<option>Password Reset</option>
<option>Order Entry</option>
<option>Order Status / Tracking</option>
<option>General Inquiry</option>
</select>
<button onclick="exportCSV()">üì§ Export CSV</button>
</div>
</div>

<table>
<thead>
<tr>
<th>Tool</th><th>Company</th><th>Name</th><th>Phone</th><th>Ref</th>
<th>Disposition</th><th>Status</th><th>Notes</th><th>Date</th><th id="adminCol" class="hidden">Admin</th>
</tr>
</thead>
<tbody id="logTable"></tbody>
</table>

<canvas id="chart" height="100"></canvas>

<!-- ADMIN -->
<div id="adminPanel" class="admin hidden">
<h3>üë§ Agent Performance</h3>
<table>
<thead>
<tr><th>Agent</th><th>Total</th><th>Resolved</th><th>Open</th></tr>
</thead>
<tbody id="agentTable"></tbody>
</table>
</div>

</div>
</div>

<script>
/* ========= FIREBASE INIT ========= */
firebase.initializeApp({
  apiKey: "AIzaSyBEbq_d9nGXFLNdHaWICDfOzvQECC6yjOQ",
  authDomain: "call-logs-tool.firebaseapp.com",
  projectId: "call-logs-tool"
});
const db = firebase.firestore();

/* ADMIN EMAILS */
const ADMIN_EMAILS = ["admin@yourcompany.com"];

/* TOOL ‚Üí COMPANY */
const companyMap={
 Shopify:["Bayada Wear","First Watch Shop","First Watch Swag"],
 Marcom:["Cash America","Choice Hotels","Dave & Buster's / Main Event"],
 "Marketing Bench":["23 Restaurant Services","Aaron's, Inc.","Access Marketing Services"]
};

let currentUser="",isAdmin=false,logs=[],chart;

function toggleTheme(){document.body.classList.toggle("dark")}
function logout(){location.reload()}

function loadCompanies(){
 company.disabled=false;
 company.innerHTML='<option value="">Select Company *</option>';
 companyMap[tool.value].forEach(c=>company.innerHTML+=`<option>${c}</option>`);
}

function login(){
 currentUser=loginEmail.value.trim();
 if(!currentUser) return alert("Email required");

 isAdmin = ADMIN_EMAILS.includes(currentUser);

 agentBadge.textContent="Agent: "+currentUser;
 agentBadge.classList.remove("hidden");
 logoutBtn.classList.remove("hidden");
 loginSection.classList.add("hidden");
 appSection.classList.remove("hidden");

 if(isAdmin){
  adminPanel.classList.remove("hidden");
  adminCol.classList.remove("hidden");
 }

 listenLogs();
}

async function addLog(){
 await db.collection("logs").add({
  agent:currentUser,
  tool:tool.value,
  company:company.value,
  name:fullName.value,
  phone:phone.value,
  refId:refId.value,
  disposition:disposition.value,
  status:status.value,
  notes:notes.value,
  created:firebase.firestore.FieldValue.serverTimestamp(),
  day:new Date().toISOString().split("T")[0]
 });
}

function listenLogs(){
 db.collection("logs").orderBy("created","desc").onSnapshot(s=>{
  logs=s.docs.map(d=>({id:d.id,...d.data()}));
  renderLogs();
  renderStats();
  renderChart();
  if(isAdmin) renderAgentTable();
 });
}

function renderStats(){
 const mine=logs.filter(l=>l.agent===currentUser);
 statTotal.textContent=mine.length;
 statResolved.textContent=mine.filter(l=>l.status==="Resolved").length;
 statOpen.textContent=mine.filter(l=>l.status!=="Resolved").length;
}

function renderLogs(){
 logTable.innerHTML="";
 logs.filter(l=>{
  return (!filterCompany.value||l.company?.toLowerCase().includes(filterCompany.value.toLowerCase()))
   &&(!filterDate.value||l.day===filterDate.value)
   &&(!filterDisposition.value||l.disposition===filterDisposition.value)
   &&JSON.stringify(l).toLowerCase().includes(searchText.value.toLowerCase());
 }).forEach(l=>{
  logTable.innerHTML+=`
  <tr>
   <td>${l.tool}</td>
   <td>${l.company}</td>
   <td>${l.name}</td>
   <td>${l.phone}</td>
   <td>${l.refId}</td>
   <td>${l.disposition}</td>
   <td>${l.status}</td>
   <td><div class="note-box">${l.notes}</div></td>
   <td>${l.created?.toDate().toLocaleString()||""}</td>
   ${isAdmin?`<td><button onclick="deleteLog('${l.id}')">üóëÔ∏è</button></td>`:""}
  </tr>`;
 });
}

async function deleteLog(id){
 if(confirm("Delete this log?")){
  await db.collection("logs").doc(id).delete();
 }
}

function renderAgentTable(){
 const map={};
 logs.forEach(l=>{
  if(!map[l.agent]) map[l.agent]={total:0,res:0};
  map[l.agent].total++;
  if(l.status==="Resolved") map[l.agent].res++;
 });

 agentTable.innerHTML="";
 Object.entries(map).forEach(([a,v])=>{
  agentTable.innerHTML+=`
  <tr>
   <td>${a}</td>
   <td>${v.total}</td>
   <td>${v.res}</td>
   <td>${v.total-v.res}</td>
  </tr>`;
 });
}

function renderChart(){
 const map={};
 logs.forEach(l=>map[l.day]=(map[l.day]||0)+1);
 if(chart) chart.destroy();
 chart=new Chart(document.getElementById("chart"),{
  type:"bar",
  data:{labels:Object.keys(map),datasets:[{label:"Logs Per Day",data:Object.values(map)}]}
 });
}

function exportCSV(){
 let csv="Tool,Company,Name,Phone,Ref,Disposition,Status,Date\n";
 logs.forEach(l=>csv+=`${l.tool},${l.company},${l.name},${l.phone},${l.refId},${l.disposition},${l.status},${l.day}\n`);
 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([csv]));
 a.download="call_logs.csv";
 a.click();
}
</script>

</body>
</html>
