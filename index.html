<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Call Logs Tool</title>

<!-- Favicon (prevents 404 error) -->
<link rel="icon" href="data:,">

<!-- Firebase COMPAT -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#f4f6f9;
  --card:#fff;
  --primary:#5b2be0;
  }
  .sla-ok {
  color: #2e7d32;
  font-weight: bold;
}

.sla-warning {
  color: #d32f2f;
  font-weight: bold;
}

.sla-breached {
  color: #b71c1c;
  font-weight: bold;

}
.toast{
  position:fixed;
  top:20px;
  right:20px;
  background:#5b2be0;
  color:#fff;
  padding:12px 18px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,.2);
  z-index:9999;
  opacity:0;
  transform:translateY(-20px);
  pointer-events:none;
  transition:opacity .4s ease, transform .4s ease;
}
.toast.show{
  opacity:1;
  transform:translateY(0);
}
body{margin:0;font-family:Arial;background:var(--bg)}
header{display:none;justify-content:space-between;align-items:center;padding:10px 20px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.container{max-width:1200px;margin:auto;padding:20px}
.card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);margin-bottom:20px}
input,select,textarea{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc}
.primary{background:var(--primary);color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer}
.logout{background:#666;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #ddd;font-size:13px;text-align:left}
.hidden{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
.modal-content{background:#fff;padding:20px;border-radius:10px;max-width:500px;width:90%}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" class="container">
  <div class="card" style="max-width:420px;margin:auto;text-align:center">
    <img src="./images/SL-Logo5.png" height="95">
    <h2>Login</h2>
    <input id="loginEmail" type="email" placeholder="name@supplylogic.com">
    <input id="loginPassword" type="password" placeholder="Password">
    <button class="primary" onclick="login()">Login</button>
  </div>
</div>

<!-- HEADER -->
<header id="appHeader">
  <img src="./images/SL-Logo4.png" height="95">
  <div>
    <span id="userEmail"></span>
    <button class="logout" onclick="logout()">Logout</button>
  </div>
</header>

<!-- APP -->
<div id="app" class="container hidden">

  <!-- AGENT FORM -->
  <div id="agentForm" class="card">
    <h3>New Call Log</h3>
    <input id="customer" placeholder="Customer Name">
    <input id="phone" placeholder="Phone Number">
    <input id="refId" placeholder="User ID / Order # / INV #">
    <select id="tool" onchange="loadCompanies()">
     <option value="">Select Tool</option>
     <option>Shopify</option>
     <option>Marcom</option>
     <option>Marketing Bench</option>
     <option>Other</option>
    </select>
    <select id="company"></select>
    <select id="disposition" onchange="checkDispositionReason()">
  <option>Password Reset</option>
  <option>Order Entry</option>
  <option>Order Status/ Tracking</option>
  <option>Impersonate</option>
  <option>Invoice</option>
  <option>Disconnect/ GhostCall</option>
  <option>Other Department</option>
  <option>Refer to AM</option>
</select>
    <select id="amReason" class="hidden">
  <option value="">Select AM Reason</option>
  <option>Account creation</option>
  <option>Account transfer to a new manager, director, etc</option>
  <option>Back order</option>
  <option>Inventory</option>
  <option>Order Pending</option>
  <option>Order Approval</option>
  <option>Website update</option>
  <option>Other</option>
  <option>Disconnect/ GhostCall</option>
</select>

    <select id="status">
      <option>Open</option>
      <option>Follow-up</option>
      <option>Resolved</option>
    </select>
    <textarea id="notes" rows="6">Concern:

Action Taken:</textarea>
    <button class="primary" onclick="saveLog()">Submit Log</button>
  </div>
  
  <!-- AGENT DAILY STATS -->
  <div class="card">
    <h3>My Daily Stats</h3>
    <input type="date" id="agentDay">
    <button class="primary" onclick="loadAgentStats()">View</button>
    <div id="agentStatsResult" style="margin-top:15px;"></div>
    <div id="agentStats"></div>
  </div>

  <!-- AGENT HISTORY -->
  <div class="card">
    <h3>History</h3>
    <input type="text" id="searchCustomer" placeholder="Search by Customer">
    <select id="filterCompany"></select>
    <input type="date" id="filterStartDate">
    <input type="date" id="filterEndDate">
    <button class="primary" onclick="loadLogs()">Search / Filter</button>
    <table>
      <thead>
       <tr>
  <th>Customer</th>
  <th>Phone</th>
  <th>Company</th>
  <th>Disposition</th>
  <th>Status</th>
  <th>Agent</th>
  <th>Date</th>
  <th>SLA</th>
  <th>Notes</th>
  <th></th>
</tr>

      </thead>
      <tbody id="logTable"></tbody>
    </table>
    <div id="paginationControls" style="margin-top:15px;text-align:center"></div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="card hidden">
    <h3>Admin Analytics</h3>
    <input type="date" id="adminStartDate">
    <input type="date" id="adminEndDate">
    <button class="primary" onclick="loadAdminAnalytics()">Run Analytics</button>
    <hr>
    <div id="leaderboard"></div>
    <div id="analytics"></div>
    <button class="primary" onclick="exportCSV()">Export CSV</button>
  </div>

</div>

<!-- NOTES MODAL -->
<div id="notesModal" class="modal">
  <div class="modal-content">
    <div id="modalText"></div>
    <button class="primary" onclick="closeModal()">Close</button>
  </div>
</div>

  <div id="statusEditModal" class="modal">
  <div class="modal-content">
    <h3>Edit Status</h3>

    <select id="editStatusSelect">
      <option>Open</option>
      <option>Follow-up</option>
      <option>Resolved</option>
    </select>

    <button class="primary" onclick="updateStatus()">Update</button>
    <button onclick="closeStatusModal()">Cancel</button>
  </div>
</div>

<div id="actionToast" class="toast"></div>

<script>
/* ================================
ENTERPRISE CLEAN MASTER VERSION
================================ */

firebase.initializeApp({
  apiKey:"AIzaSyBEbq_d9nGXFlHaWICDfOzvQECC6yjOQ",
  authDomain:"call-logs-tool.firebaseapp.com",
  projectId:"call-logs-tool"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* STATE */
let isAdmin=false;
let editLogId=null;
let submissionLock=false;

let currentPage=1;
const pageSize=15;

/* ================= LOGIN ================= */

function login(){

  const email=loginEmail.value.trim();

  if(!email.endsWith("@supplylogic.com")){
    alert("Only supplylogic email allowed");
    return;
  }

  auth.signInWithEmailAndPassword(
    email,
    loginPassword.value
  ).catch(e=>alert(e.message));

}

/* ================= LOGOUT ================= */

function logout(){
  stopSlaAutoRefresh();
  auth.signOut();
}

/* ================= AUTH STATE ================= */

auth.onAuthStateChanged(u=>{

  if(!u){
  loginPage.classList.remove("hidden");
  app.classList.add("hidden");
  return;
}

  showToast("‚úÖ Login successful",2000);

  isAdmin=u.email.startsWith("admin");

  loginPage.classList.add("hidden");
  app.classList.remove("hidden");
  appHeader.style.display="flex";

  userEmail.textContent=u.email;

  if(isAdmin){
    adminPanel.classList.remove("hidden");
    agentForm.classList.add("hidden");
  }

  loadLogs();
  startSlaAutoRefresh();

});
  
/* =========================================================
COMPANIES DATA
=========================================================*/
const companies={

  "Shopify":[
    "Bayada Wear","First Watch Shop","First Watch Swag","KOC","Learfield",
    "Raising Cane's Gear","Sevita","The Home Homer",
    "Dave & Buster's","Premise Health"
  ],
  "Marcom":[
    "American Airlines Credit Union","Applebee's","Brinker","Cash America",
    "Choice Hotels","Dave & Buster's / Main Event","Denny's",
    "Fogo de Chao","IHOP","Noodles & Company","Pei Wei",
    "Pizza Hut","Steak N Shake","ZAXBYS","BAYADA","NAPAMARTKITECT","TomsWatch"
  ],
  "Marketing Bench":[
    "23 Restaurant Services","Aaron's, Inc.","Access Marketing Services","AdventHealth",
    "Agora Marketing Solutions, Inc.","Altium Packaging","AmeriHealth Caritas Services, LLC",
    "Arvest Bank","Baltimore Ravens","Baptist Memorial Health Care Corp",
    "BBI / Outback","Bonefish Grill","Brightview Senior Living","CACI","Cambria Properties",
    "CareFirst Management Company LLC","Carelon Behavioral Health","CarMax",
    "Carrabba's Italian Grill","Chicken Salad Chick","CIS-Knights of Columbus",
    "Compupay","Constellation Energy Generation LLC","Cumberland Pharmaceuticals",
    "D.R. Horton","Delaware North","DS Services of America, Inc.","Equistar Chemicals, LP",
    "Essential Brands dba/Kiddie Academy","First Busey Corporation","First Command",
    "First Watch Restaurants","Fleming's","Fraternal-Knights of Columbus","Georgia Power",
    "Hampton Inn & Suites - Hilton WW","HGI-Food & Beverage","Hilton Brands marKIT Orders",
    "Hilton F&B","HughesNet","Inventory/Coupa-Knights of Columbus",
    "James Hardie Bldg Products","Johns Manville","Keolis Transit America, Inc.",
    "Keplr Vision","KeyBank-WHS","La Quinta by Wyndham Hotels&Resorts",
    "Learfield Communications, LLC","LHC Group, Inc.","LYB Company Store","M&T Bank",
    "MAA Open Arms Program","Magellan Health","Magellan MFLC","Medstar Health",
    "Merry Maids","MileOne Autogroup","Modivcare","Natl. Mentor DBA Sevita",
    "NVR Marketing Services","Paycom Payroll Holdings","Piedmont Healthcare",
    "Pinch A Penny, Inc","Populus Fin. Group DBA ACE Cash Exp",
    "Preferred Hotel Group","Premise Health","Printpack","Qiagen",
    "SAIA Motor Freight Line, LLC","Sales Resource Center","Sick, Inc",
    "Southern Company Gas","Spanish site-Knights of Columbus",
    "Specialty Dental Brands","SSP America","Taub Family Selections",
    "Test Account Training","The Villages Operating Company","Transwestern",
    "Triad Advertising Corp","Trillium Health Resources","UMROI","Under Armour",
    "University of MD Medical System","Webb Mason Commercial",
    "Webb/Mason Company Store","Westmoor Mfg Co",
    "Wyndham Hotels&Resorts, Inc.","Yokohama Off Highway Tires"
  ],
   Other:["Other"]
};

/* =========================================================
COMPANY FILTER LOADER
=========================================================*/
function loadCompanies(){

  const tool=document.getElementById("tool").value;
  const companyEl=document.getElementById("company");

  companyEl.innerHTML='<option value="">Select Company</option>';

  if(!tool) return;

  const list=companies[tool];

  if(list){
    list.forEach(c=>{
      const o=document.createElement("option");
      o.value=o.textContent=c;
      companyEl.appendChild(o);
    });
  }

  const other=document.createElement("option");
  other.value="Other";
  other.textContent="Other";
  companyEl.appendChild(other);
}

/* =========================================================
DISPOSITION LOGIC
=========================================================*/
function checkDispositionReason(){

  const disp=document.getElementById("disposition").value;
  const amBox=document.getElementById("amReason");

  if(disp==="Refer to AM"){
    amBox.classList.remove("hidden");
  }else{
    amBox.classList.add("hidden");
    amBox.value="";
  }
}

/* ================= TOAST ================= */

function showToast(msg,duration=2500){

  const t=document.getElementById("actionToast");

  t.textContent=msg;
  t.classList.add("show");

  setTimeout(()=>{
    t.classList.remove("show");
  },duration);

}
/* ================= SAVE LOG ================= */

function saveLog(){

  if(submissionLock) return;
  submissionLock=true;
  setTimeout(()=>submissionLock=false,1500);

  if(!auth.currentUser){
    alert("Not authenticated");
    return;
  }

  const customerEl=document.getElementById("customer");
  const phoneEl=document.getElementById("phone");
  const refEl=document.getElementById("refId");
  const toolEl=document.getElementById("tool");
  const companyEl=document.getElementById("company");
  const dispositionEl=document.getElementById("disposition");
  const statusEl=document.getElementById("status");
  const notesEl=document.getElementById("notes");

  if(!customerEl.value.trim()){
    alert("Customer required");
    return;
  }

  db.collection("logs").add({

    customer:customerEl.value.trim(),
    phone:phoneEl.value.trim(),
    ref:refEl.value.trim(),
    tool:toolEl.value,
    company:companyEl.value,
    disposition:dispositionEl.value,
    amReason:amReason.value,
    status:statusEl.value||"Open",
    notes:notesEl.value.trim(),
    agent:auth.currentUser.email,

    created:firebase.firestore.FieldValue.serverTimestamp(),
    createdDay:new Date().toISOString().slice(0,10)

  }).then(()=>{

    customerEl.value="";
    phoneEl.value="";
    refEl.value="";
    notesEl.value="Concern:\n\nAction Taken:";

    showToast("‚úÖ Log saved");

    loadLogs();

  });

}

/* ================= LOAD LOGS PAGINATION ================= */

function loadLogs(page=1){

  currentPage=page;

  const table=document.getElementById("logTable");
  const pagination=document.getElementById("paginationControls");

  table.innerHTML="";
  pagination.innerHTML="";

  let query=db.collection("logs")
    .orderBy("created","desc");

  const search=searchCustomer.value.trim().toLowerCase();
  const companyFilter=filterCompany.value;
  const startDate=filterStartDate.value;
  const endDate=filterEndDate.value;

  if(companyFilter)
    query=query.where("company","==",companyFilter);

  if(startDate)
    query=query.where("createdDay",">=",startDate);

  if(endDate)
    query=query.where("createdDay","<=",endDate);

  query.get().then(snapshot=>{

    let logs=[];

    snapshot.forEach(doc=>{

      const l=doc.data();

      if(search && !l.customer?.toLowerCase().includes(search))
        return;

      logs.push({id:doc.id,data:l});

    });

    const totalPages=Math.ceil(logs.length/pageSize);

    const start=(page-1)*pageSize;
    const paginated=logs.slice(start,start+pageSize);

    paginated.forEach(item=>{

      const l=item.data;
      const created=l.created?.toDate?.();

      let slaText="‚Äî";
      let slaClass="";

      if(created && l.status!=="Resolved"){

        const SLA_HOURS=48;
        const elapsed=(Date.now()-created.getTime())/3600000;

        if(elapsed>=SLA_HOURS){
          slaText="‚ùå Breached";
          slaClass="sla-breached";
        }
        else if(elapsed>=40){
          slaText="‚ö†Ô∏è Warning";
          slaClass="sla-warning";
        }
        else{
          slaText="‚è≥ OK";
          slaClass="sla-ok";
        }
      }

      const tr=document.createElement("tr");

      tr.innerHTML=`
        <td>${l.customer||""}</td>
        <td>${l.phone||""}</td>
        <td>${l.company||""}</td>
        <td>${l.disposition||""}</td>
        <td>${l.status||""}</td>
        <td>${l.agent||""}</td>
        <td>${created?created.toLocaleString():""}</td>
        <td><span class="${slaClass}">${slaText}</span></td>
        <td><button onclick="viewNotes('${item.id}')">View</button></td>
      `;

      table.appendChild(tr);

    });

    if(totalPages>1){

      let controls="";

      if(currentPage>1)
        controls+=`<button class="primary" onclick="loadLogs(${currentPage-1})">Previous</button>`;

      controls+=` Page ${currentPage} of ${totalPages} `;

      if(currentPage<totalPages)
        controls+=`<button class="primary" onclick="loadLogs(${currentPage+1})">Next</button>`;

      pagination.innerHTML=controls;

    }

  });

}


  /* =========================================================
STATUS UPDATE SAFE
=========================================================*/
function updateStatus(){

  if(!editLogId) return;

  const newStatus=editStatusSelect.value;

  db.collection("logs").doc(editLogId).update({
    status:newStatus
  }).then(()=>{

    showToast("‚úÖ Status updated");

    closeStatusModal();
    loadLogs();

    editLogId=null;

  }).catch(e=>alert(e.message));

}
  async function loadAgentStats(){

  try{

    const selectedDate = document.getElementById("agentDay").value;
    if(!selectedDate){
      alert("Please select a date.");
      return;
    }

    const resultBox = document.getElementById("agentStatsResult");
    resultBox.innerHTML = "Loading...";

    let query = db.collection("logs")
                  .where("createdDay","==",selectedDate);

    // If NOT admin ‚Üí only show own stats
    if(!isAdmin){
      query = query.where("agent","==",auth.currentUser.email);
    }

    const snapshot = await query.get();

    if(snapshot.empty){
      resultBox.innerHTML = "<b>No records found for selected date.</b>";
      return;
    }

    let total = 0;
    let open = 0;
    let resolved = 0;
    let sameDayResolved = 0;

    snapshot.forEach(doc=>{
      const data = doc.data();
      total++;

      if(data.status === "Resolved"){
        resolved++;

        if(data.created && data.created.toDate){
          const createdDate = data.created.toDate().toISOString().slice(0,10);
          if(createdDate === selectedDate){
            sameDayResolved++;
          }
        }

      }else{
        open++;
      }
    });

    resultBox.innerHTML = `
      <div style="background:#f4f6f9;padding:15px;border-radius:8px">
        <h3 style="margin:0 0 10px 0;">Agent Daily Stats (${selectedDate})</h3>
        <p><b>Total Logs:</b> ${total}</p>
        <p><b>Open:</b> ${open}</p>
        <p><b>Resolved:</b> ${resolved}</p>
        <p><b>Resolved Same Day:</b> ${sameDayResolved}</p>
      </div>
    `;

  }catch(error){
    console.error(error);
    alert("Error loading stats: " + error.message);
  }

}

/* =========================================================
MODALS
=========================================================*/
function closeModal(){
  notesModal.style.display="none";
}

function closeStatusModal(){
  statusEditModal.style.display="none";
}

/* ================= NOTES ================= */

function viewNotes(id){

  db.collection("logs").doc(id).get().then(doc=>{

    if(!doc.exists) return;

    const notes=doc.data().notes||"";

    const [concernPart,actionPart]=notes.split("Action Taken:");

    modalText.innerHTML=`
    <b>Concern</b><br><br>
    ${concernPart?.replace("Concern:","").trim()||""}
    <br><br>
    <b>Action Taken</b><br><br>
    ${actionPart?.trim()||""}
    `;

    notesModal.style.display="flex";

  });

}
/* =========================================================
CSV EXPORT SAFE
=========================================================*/
function exportCSV(){

  db.collection("logs").get().then(snapshot=>{

    let csv="Customer,Phone,Company,Disposition,Status,Agent,Date,Notes\n";

    snapshot.forEach(doc=>{

      const l=doc.data();
      const created=l.created?.toDate?.() || "";

      csv+=`${l.customer||""},${l.phone||""},${l.company||""},${l.disposition||""},${l.status||""},${l.agent||""},${created},"${(l.notes||"").replace(/\n/g," ")}"\n`;

    });

    const blob=new Blob([csv],{type:"text/csv"});
    const url=URL.createObjectURL(blob);

    const a=document.createElement("a");
    a.href=url;
    a.download="call_logs_report.csv";
    a.click();

  });

}

/* ================= DELETE ================= */

function deleteLog(id){

  if(!confirm("Delete this log?")) return;

  db.collection("logs").doc(id).delete().then(()=>{

    showToast("üóëÔ∏è Log deleted");
    loadLogs();

  });

}

/* ================= SLA REFRESH ================= */

let slaAutoRefresh=null;

function startSlaAutoRefresh(){

  if(slaAutoRefresh) return;

  slaAutoRefresh=setInterval(()=>{
    if(!app.classList.contains("hidden"))
      loadLogs(currentPage);
  },60000);

}

function stopSlaAutoRefresh(){

  if(slaAutoRefresh){
    clearInterval(slaAutoRefresh);
    slaAutoRefresh=null;
  }

}

</script>

</body>
</html>

















