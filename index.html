<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Knowledge Base Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- FONT -->
<link href="https://fonts.googleapis.com/css2?family=Aptos:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- CHART -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Aptos, sans-serif;
  background:#f5f6fa;
  color:#222;
}
.dark{
  background:#111;
  color:#eee;
}

header{
  display:flex;
  align-items:center;
  padding:10px 16px;
  background:#2f6fed;
  color:#fff;
}
header img{height:36px;margin-right:12px}
.hidden{display:none}

button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.primary{background:#2f6fed;color:#fff}
.danger{background:#c0392b;color:#fff}

input,select,textarea{
  width:100%;
  padding:8px;
  margin:4px 0 12px;
}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:8px;
  border-bottom:1px solid #ddd;
}

.card{
  background:#fff;
  padding:16px;
  border-radius:10px;
  margin:12px;
}
.dark .card{background:#1e1e1e}
</style>
</head>

<body>

<header>
  <img src="logo.png">
  <strong>Knowledge Base Tool</strong>
  <div style="margin-left:auto">
    <button onclick="toggleDark()">ðŸŒ™</button>
    <button id="logoutBtn" onclick="logout()" class="danger hidden">Logout</button>
  </div>
</header>

<!-- LOGIN -->
<div id="login" class="card">
  <h2>Login</h2>
  <input id="username" placeholder="Enter name">
  <input id="password" type="password" placeholder="Password">
  <button class="primary" onclick="loginUser()">Login</button>
</div>

<!-- AGENT -->
<div id="agent" class="hidden">
  <div class="card">
    <h3>Submit Log</h3>

    <select id="tool">
      <option value="">Select Tool *</option>
      <option>Shopify</option>
      <option>Marcom</option>
      <option>Marketing Bench</option>
    </select>

    <select id="company" disabled>
      <option value="">Select Company *</option>
    </select>

    <input id="ref" placeholder="Reference #">

    <select id="disposition">
      <option value="">Disposition *</option>
      <option>Resolved</option>
      <option>Pending</option>
    </select>

    <textarea id="notes">CONCERN:

ACTION TAKEN:</textarea>

    <button class="primary" onclick="submitLog()">Submit</button>
  </div>

  <div class="card">
    <h3>My Logs</h3>
    <table>
      <thead>
        <tr><th>Date</th><th>Tool</th><th>Company</th><th>Minutes</th></tr>
      </thead>
      <tbody id="agentLogs"></tbody>
    </table>
  </div>
</div>

<!-- ADMIN -->
<div id="admin" class="hidden">
  <div class="card">
    <h3>Admin Filters</h3>
    <input type="date" id="from">
    <input type="date" id="to">
  </div>

  <div class="card">
    <canvas id="chart"></canvas>
  </div>

  <div class="card">
    <h3>All Logs</h3>
    <table>
      <thead>
        <tr><th>Agent</th><th>Date</th><th>Tool</th><th>Minutes</th></tr>
      </thead>
      <tbody id="adminLogs"></tbody>
    </table>
  </div>
</div>

<script>
/* ðŸ”¥ FIREBASE */
const firebaseConfig={
  apiKey:"AIzaSyBEbq_d9nGXFLNdHaWICDfOzvQECC6yjOQ",
  authDomain:"call-logs-tool.firebaseapp.com",
  projectId:"call-logs-tool"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

/* ðŸ”’ SESSION */
let user = sessionStorage.getItem("user") || "";
let isAdmin = sessionStorage.getItem("admin") === "1";
let startTime = Date.now();
let logs = [];

/* ðŸŒ™ DARK MODE */
function toggleDark(){
 document.body.classList.toggle("dark");
}

/* ðŸ”‘ LOGIN */
function loginUser(){
 const u = username.value.trim();
 const p = password.value;

 if(!u || !p) return alert("Missing fields");

 user = u;
 isAdmin = p === "admin123";

 sessionStorage.setItem("user", user);
 sessionStorage.setItem("admin", isAdmin ? "1" : "0");

 init();
}

/* ðŸšª LOGOUT */
function logout(){
 sessionStorage.clear();
 location.reload();
}

/* ðŸš€ INIT */
function init(){
 login.classList.add("hidden");
 logoutBtn.classList.remove("hidden");

 if(isAdmin){
  admin.classList.remove("hidden");
  loadAdmin();
 }else{
  agent.classList.remove("hidden");
  loadAgentLogs();
 }
}

/* ðŸ“ SUBMIT LOG */
async function submitLog(){
 if(!tool.value || !company.value || !disposition.value){
  alert("Complete required fields");
  return;
 }

 const mins=((Date.now()-startTime)/60000).toFixed(2);

 await db.collection("logs").add({
  agent:user,
  tool:tool.value,
  company:company.value,
  ref:ref.value || "",
  disposition:disposition.value,
  notes:notes.value,
  minutes:Number(mins),
  date:new Date().toISOString().split("T")[0],
  created:firebase.firestore.FieldValue.serverTimestamp()
 });

 startTime = Date.now();
 ref.value="";
 notes.value="CONCERN:\n\nACTION TAKEN:";
 alert("Saved");
}

/* âŒ¨ï¸ ENTER TO SUBMIT (AGENT ONLY) */
document.addEventListener("keydown",e=>{
 if(
  e.key==="Enter" &&
  !e.shiftKey &&
  !agent.classList.contains("hidden") &&
  document.activeElement.tagName!=="TEXTAREA"
 ){
  submitLog();
 }
});

/* ðŸ“‹ AGENT LOGS */
function loadAgentLogs(){
 db.collection("logs")
 .where("agent","==",user)
 .orderBy("created","desc")
 .onSnapshot(s=>{
  agentLogs.innerHTML="";
  s.forEach(d=>{
   const r=d.data();
   agentLogs.innerHTML+=`
    <tr>
      <td>${r.date}</td>
      <td>${r.tool}</td>
      <td>${r.company}</td>
      <td>${r.minutes}</td>
    </tr>`;
  });
 });
}

/* ðŸ“Š ADMIN */
let chart;
function loadAdmin(){
 db.collection("logs").onSnapshot(s=>{
  logs = s.docs.map(d=>d.data());
  renderAdmin();
 });
}

function renderAdmin(){
 const f=from.value, t=to.value;
 const filtered = logs.filter(l=>{
  return (!f || l.date>=f) && (!t || l.date<=t);
 });

 adminLogs.innerHTML="";
 const totals={};

 filtered.forEach(l=>{
  totals[l.agent]=(totals[l.agent]||0)+l.minutes;
  adminLogs.innerHTML+=`
   <tr>
     <td>${l.agent}</td>
     <td>${l.date}</td>
     <td>${l.tool}</td>
     <td>${l.minutes}</td>
   </tr>`;
 });

 if(chart) chart.destroy();
 chart=new Chart(chart,{
  type:"bar",
  data:{
   labels:Object.keys(totals),
   datasets:[{data:Object.values(totals)}]
  }
 });
}

from.onchange = to.onchange = renderAdmin;

/* ðŸ” AUTO INIT */
if(user) init();

/* ðŸ”½ COMPANY MAP */
const map={
 Shopify:["Bayada Wear","First Watch Shop","First Watch Swag"],
 Marcom:["Cash America","Choice Hotels","Dave & Buster's / Main Event"],
 "Marketing Bench":["23 Restaurant Services","Aaron's, Inc.","Access Marketing Services"]
};

tool.onchange=()=>{
 company.innerHTML='<option value="">Select Company *</option>';
 (map[tool.value]||[]).forEach(c=>{
  company.innerHTML+=`<option>${c}</option>`;
 });
 company.disabled=!tool.value;
};
</script>
</body>
</html>
