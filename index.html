<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Call Logs Tool</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;background:#f4f6f9;margin:0}
.container{max-width:1600px;margin:30px auto;background:#fff;padding:30px;border-radius:12px}
.hidden{display:none}
input,select,textarea,button{padding:10px;width:100%;margin-bottom:12px}
button{background:#0d6efd;color:#fff;border:none;border-radius:6px;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid #ccc;padding:10px}
.note-box{white-space:pre-wrap}
.admin-panel{border:2px dashed #0d6efd;padding:20px;margin-top:30px}
.stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px}
</style>
</head>

<body>

<div class="container">

<h2>üìû Call Logs Tool</h2>

<!-- LOGIN -->
<div id="loginSection">
<input id="email" placeholder="Email">
<input id="password" placeholder="Admin Password (admins only)" type="password">
<button onclick="login()">Login</button>
</div>

<!-- AGENT -->
<div id="agentSection" class="hidden">
<h3>New Call Log</h3>

<select id="tool">
<option value="">Tool *</option>
<option>Shopify</option>
<option>Marcom</option>
<option>Marketing Bench</option>
</select>

<select id="company">
<option value="">Company *</option>
<option>Bayada Wear</option>
<option>First Watch Shop</option>
<option>First Watch Swag</option>
<option>Cash America</option>
<option>Choice Hotels</option>
<option>Dave & Buster's / Main Event</option>
<option>23 Restaurant Services</option>
<option>Aaron's, Inc.</option>
<option>Access Marketing Services</option>
</select>

<input id="name" placeholder="Customer Name">
<input id="phone" placeholder="Phone">
<input id="ref" placeholder="Reference #">

<select id="disposition">
<option value="">Disposition *</option>
<option>Password Reset</option>
<option>Order Entry</option>
<option>Order Status</option>
<option>General Inquiry</option>
</select>

<select id="status">
<option>Open</option>
<option>Follow Up</option>
<option>Resolved</option>
</select>

<textarea id="notes">CONCERN:

ACTION TAKEN:</textarea>

<button onclick="submitLog()">Submit Log</button>
</div>

<!-- ADMIN -->
<div id="adminSection" class="hidden admin-panel">

<h3>üìä Admin Analytics</h3>

<div class="stats-grid">
<canvas id="logsPerDay"></canvas>
<canvas id="topDisposition"></canvas>
<canvas id="topCompany"></canvas>
</div>

<h4>‚è±Ô∏è Avg Notation Minutes per Agent</h4>
<table>
<thead><tr><th>Agent</th><th>Avg Minutes</th></tr></thead>
<tbody id="timeTable"></tbody>
</table>

<button onclick="exportCSV()">üì§ Export CSV</button>

<h4>üóëÔ∏è Logs</h4>
<table>
<thead>
<tr><th>Agent</th><th>Company</th><th>Disposition</th><th>Minutes</th><th>Date</th><th>Action</th></tr>
</thead>
<tbody id="adminLogs"></tbody>
</table>

</div>

</div>

<script>
/* FIREBASE */
firebase.initializeApp({
 apiKey:"AIzaSyBEbq_d9nGXFLNdHaWICDfOzvQECC6yjOQ",
 authDomain:"call-logs-tool.firebaseapp.com",
 projectId:"call-logs-tool"
});
const db=firebase.firestore();

/* GLOBALS */
let user="",isAdmin=false,startTime=0,logs=[];

/* ENTER KEY LOGIN */
document.addEventListener("keydown",e=>{
 if(e.key==="Enter" && !loginSection.classList.contains("hidden")) login();
});

/* LOGIN */
function login(){
 user=email.value.trim();
 if(!user) return alert("Email required");

 if(password.value){
  if(password.value!=="rperez@123") return alert("Wrong admin password");
  isAdmin=true;
 }

 loginSection.classList.add("hidden");
 if(isAdmin){
  adminSection.classList.remove("hidden");
  loadAdmin();
 } else {
  agentSection.classList.remove("hidden");
  startTimer();
 }
}

/* TIMER */
function startTimer(){
 document.addEventListener("input",()=>{
  if(!startTime) startTime=Date.now();
 },{once:true});
}

/* SUBMIT LOG */
async function submitLog(){
 const mins=((Date.now()-startTime)/60000).toFixed(2);
 await db.collection("logs").add({
  agent:user,
  company:company.value,
  disposition:disposition.value,
  status:status.value,
  notes:notes.value,
  minutes:+mins,
  date:new Date().toISOString().split("T")[0],
  created:firebase.firestore.FieldValue.serverTimestamp()
 });
 alert("Log saved");
 location.reload();
}

/* ADMIN LOAD */
function loadAdmin(){
 db.collection("logs").onSnapshot(s=>{
  logs=s.docs.map(d=>({id:d.id,...d.data()}));
  renderCharts();
  renderTimes();
  renderAdminLogs();
 });
}

/* CHARTS */
function renderCharts(){
 const perDay={},disp={},comp={};
 logs.forEach(l=>{
  perDay[l.date]=(perDay[l.date]||0)+1;
  disp[l.disposition]=(disp[l.disposition]||0)+1;
  comp[l.company]=(comp[l.company]||0)+1;
 });
 chart("logsPerDay","Logs Per Day",perDay);
 chart("topDisposition","Top Disposition",disp);
 chart("topCompany","Top Company",comp);
}

function chart(id,label,data){
 new Chart(document.getElementById(id),{
  type:"bar",
  data:{labels:Object.keys(data),datasets:[{label,data:Object.values(data)}]}
 });
}

/* TIME TABLE */
function renderTimes(){
 const map={};
 logs.forEach(l=>{
  if(!map[l.agent]) map[l.agent]=[];
  map[l.agent].push(l.minutes);
 });
 timeTable.innerHTML="";
 Object.entries(map).forEach(([a,v])=>{
  const avg=(v.reduce((x,y)=>x+y,0)/v.length).toFixed(2);
  timeTable.innerHTML+=`<tr><td>${a}</td><td>${avg}</td></tr>`;
 });
}

/* ADMIN LOGS */
function renderAdminLogs(){
 adminLogs.innerHTML="";
 logs.forEach(l=>{
  adminLogs.innerHTML+=`
  <tr>
   <td>${l.agent}</td>
   <td>${l.company}</td>
   <td>${l.disposition}</td>
   <td>${l.minutes}</td>
   <td>${l.date}</td>
   <td><button onclick="del('${l.id}')">Delete</button></td>
  </tr>`;
 });
}

async function del(id){
 if(confirm("Delete log?")) await db.collection("logs").doc(id).delete();
}

/* EXPORT */
function exportCSV(){
 let csv="Agent,Company,Disposition,Minutes,Date\n";
 logs.forEach(l=>csv+=`${l.agent},${l.company},${l.disposition},${l.minutes},${l.date}\n`);
 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([csv]));
 a.download="logs.csv";
 a.click();
}
</script>

</body>
</html>
