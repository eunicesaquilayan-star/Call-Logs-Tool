<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Call Logs Tool</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root{
 --bg:#f4f6f9;--card:#fff;--text:#212529;--border:#dee2e6;--primary:#0d6efd
}
body.dark{
 --bg:#121212;--card:#1e1e1e;--text:#e9ecef;--border:#2a2a2a
}
body{font-family:Arial;background:var(--bg);color:var(--text);margin:0}
.container{max-width:1600px;margin:30px auto;background:var(--card);padding:30px;border-radius:12px}
header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--border);padding-bottom:15px}
button{background:var(--primary);color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer}
input,select,textarea{width:100%;padding:10px;margin-bottom:12px;border-radius:6px;border:1px solid var(--border)}
textarea{min-height:180px}
.hidden{display:none}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid var(--border);padding:10px}
.small{font-size:13px;opacity:.85}
.analytics{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-top:20px}
.card{padding:15px;border:1px solid var(--border);border-radius:10px}
</style>
</head>

<body>

<div class="container">

<header>
 <img src="./images/SL-Logo4.png" height="95">
 <div>
  <button onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
  <button id="logoutBtn" class="hidden" onclick="logout()">Logout</button>
 </div>
</header>

<!-- LOGIN -->
<div id="loginSection">
 <h3>Login</h3>
 <input id="email" placeholder="Email">
 <input id="password" type="password" placeholder="Admin password (admins only)">
 <button onclick="login()">Login</button>
</div>

<!-- ADMIN -->
<div id="adminSection" class="hidden">
 <h3>üìä Admin Analytics</h3>

 <button onclick="exportCSV()">‚¨á Export CSV</button>

 <div class="analytics">
  <div class="card"><b>Logs Today</b><div id="logsToday">0</div></div>
  <div class="card"><b>Top Company</b><div id="topCompany">-</div></div>
  <div class="card"><b>Top Disposition</b><div id="topDisposition">-</div></div>
  <div class="card"><b>Resolved %</b><div id="resolvedPct">0%</div></div>
 </div>
</div>

<!-- AGENT -->
<div id="agentSection" class="hidden">

<h3>New Call Log</h3>

<select id="tool" onchange="loadCompanies()">
 <option value="">Select Tool *</option>
 <option>Shopify</option>
 <option>Marcom</option>
 <option>Marketing Bench</option>
</select>

<select id="company" disabled>
 <option value="">Select Company *</option>
</select>

<input id="name" placeholder="Customer Name">
<input id="phone" placeholder="Phone">
<input id="ref" placeholder="User ID / Order # / Inv #">

<select id="disposition">
 <option value="">Disposition *</option>
 <option>Password Reset</option>
 <option>Order Entry</option>
 <option>Order Status</option>
 <option>General Inquiry</option>
</select>

<select id="status">
 <option>Open</option>
 <option>Follow Up</option>
 <option>Resolved</option>
</select>

<textarea id="notes">CONCERN:

ACTION TAKEN:</textarea>

<button onclick="submitLog()">Submit Log</button>

<h3>History</h3>

<select id="filterCompany" onchange="loadAgentLogs()">
 <option value="">All Companies</option>
</select>

<input type="date" id="filterDate" onchange="loadAgentLogs()">

<table>
<thead>
<tr>
<th>Customer</th><th>Company</th><th>Disposition</th><th>Status</th><th>Notes</th><th>Date</th>
</tr>
</thead>
<tbody id="agentLogs"></tbody>
</table>

</div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyBEbq_d9nGXFLNdHaWICDfOzvQECC6yjOQ",
 authDomain:"call-logs-tool.firebaseapp.com",
 projectId:"call-logs-tool"
});

const db=firebase.firestore();
const auth=firebase.auth();

let user="", isAdmin=false, startTime=Date.now();

auth.signInAnonymously();

function toggleTheme(){document.body.classList.toggle("dark")}

function login(){
 user=email.value.trim();
 if(!user) return alert("Email required");

 isAdmin=password.value==="SL@123";

 loginSection.classList.add("hidden");
 logoutBtn.classList.remove("hidden");

 if(isAdmin){
  adminSection.classList.remove("hidden");
  loadAnalytics();
 }else{
  agentSection.classList.remove("hidden");
  loadAgentLogs();
 }
}

function logout(){sessionStorage.clear();location.reload()}

const companyMap={
 Shopify:["Bayada Wear","First Watch Shop","First Watch Swag"],
 Marcom:["Cash America","Choice Hotels","Dave & Buster's / Main Event"],
 "Marketing Bench":["23 Restaurant Services","Aaron's, Inc.","Access Marketing Services"]
};

function loadCompanies(){
 company.innerHTML='<option value="">Select Company *</option>';
 filterCompany.innerHTML='<option value="">All Companies</option>';
 (companyMap[tool.value]||[]).forEach(c=>{
  company.add(new Option(c,c));
  filterCompany.add(new Option(c,c));
 });
 company.disabled=false;
}

async function submitLog(){
 if(!tool.value||!company.value||!disposition.value) return alert("Complete required fields");

 await db.collection("logs").add({
  agent:user,tool:tool.value,company:company.value,
  name:name.value,phone:phone.value,ref:ref.value,
  disposition:disposition.value,status:status.value,
  notes:notes.value,minutes:((Date.now()-startTime)/60000).toFixed(2),
  created:firebase.firestore.FieldValue.serverTimestamp()
 });

 tool.value="";company.innerHTML='<option value="">Select Company *</option>';company.disabled=true;
 name.value=phone.value=ref.value="";
 disposition.value="";status.value="Open";
 notes.value="CONCERN:\n\nACTION TAKEN:";
 startTime=Date.now();
 loadAgentLogs();
}

function loadAgentLogs(){
 let q=db.collection("logs").where("agent","==",user);

 if(filterCompany.value) q=q.where("company","==",filterCompany.value);

 q.orderBy("created","desc").limit(100).onSnapshot(snap=>{
  agentLogs.innerHTML="";
  snap.forEach(d=>{
   const x=d.data();
   const preview=x.notes?.slice(0,80)||"";
   agentLogs.innerHTML+=`
   <tr>
    <td>${x.name||""}</td>
    <td>${x.company}</td>
    <td>${x.disposition}</td>
    <td>${x.status}</td>
    <td title="${x.notes||""}">${preview}${x.notes?.length>80?"‚Ä¶":""}</td>
    <td>${x.created?.toDate().toLocaleString()||""}</td>
   </tr>`;
  });
 });
}

function loadAnalytics(){
 db.collection("logs").onSnapshot(snap=>{
  let total=0,res=0,companies={},disp={};

  snap.forEach(d=>{
   const x=d.data();total++;
   if(x.status==="Resolved")res++;
   companies[x.company]=(companies[x.company]||0)+1;
   disp[x.disposition]=(disp[x.disposition]||0)+1;
  });

  logsToday.textContent=total;
  topCompany.textContent=Object.keys(companies).sort((a,b)=>companies[b]-companies[a])[0]||"-";
  topDisposition.textContent=Object.keys(disp).sort((a,b)=>disp[b]-disp[a])[0]||"-";
  resolvedPct.textContent=total?Math.round(res/total*100)+"% ("+res+")":"0%";
 });
}

function exportCSV(){
 db.collection("logs").get().then(snap=>{
  let csv="Agent,Customer,Company,Disposition,Status,Date\n";
  snap.forEach(d=>{
   const x=d.data();
   csv+=`${x.agent},${x.name},${x.company},${x.disposition},${x.status},${x.created?.toDate()}\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="call-logs.csv";a.click();
 });
}
</script>
</body>
</html>
