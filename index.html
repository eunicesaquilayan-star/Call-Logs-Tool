<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Call Logs Tool</title>
<link rel="icon" href="data:,">

<!-- Firebase COMPAT -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{--bg:#f4f6f9;--card:#fff;--primary:#5b2be0;}
body{margin:0;font-family:Arial;background:var(--bg);}
header{display:none;justify-content:space-between;align-items:center;padding:10px 20px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.1);}
.container{max-width:1200px;margin:auto;padding:20px;}
.card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);margin-bottom:20px;}
input,select,textarea{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;}
.primary{background:var(--primary);color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;}
.logout{background:#666;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border-bottom:1px solid #ddd;font-size:13px;text-align:left;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;}
.modal-content{background:#fff;padding:20px;border-radius:10px;max-width:500px;width:90%;}
.toast{position:fixed;top:20px;right:20px;background:var(--primary);color:#fff;padding:12px 18px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:9999;opacity:0;transform:translateY(-20px);pointer-events:none;transition:opacity .4s ease, transform .4s ease;}
.toast.show{opacity:1;transform:translateY(0);}
.hidden{display:none;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="container">
  <div class="card" style="max-width:420px;margin:auto;text-align:center">
    <img src="./images/SL-Logo5.png" height="95">
    <h2>Login</h2>
    <input id="loginEmail" type="email" placeholder="name@supplylogic.com">
    <input id="loginPassword" type="password" placeholder="Password">
    <button class="primary" onclick="login()">Login</button>
  </div>
</div>

<!-- HEADER -->
<header id="appHeader">
  <img src="./images/SL-Logo4.png" height="95">
  <div>
    <span id="userEmail"></span>
    <button class="logout" id="logoutBtn">Logout</button>
  </div>
</header>

<!-- APP -->
<div id="app" class="container hidden">

  <!-- AGENT FORM -->
  <div id="agentForm" class="card">
    <h3>New Call Log</h3>
    <input id="customer" placeholder="Customer Name">
    <input id="phone" placeholder="Phone Number">
    <input id="refId" placeholder="User ID / Order # / INV #">
    <select id="tool" onchange="loadCompanies()">
  <option value="">Select Tool</option>
  <option value="Shopify">Shopify</option>
  <option value="Marcom">Marcom</option>
  <option value="Marketing Bench">Marketing Bench</option>
  </select>
    <select id="company">
  <option value="">Select Company</option>
</select>

    <select id="disposition">
      <option>Password Reset</option>
      <option>Order Entry</option>
      <option>Order Status/ Tracking</option>
      <option>Impersonate</option>
      <option>AM Escalation</option>
    </select>
    <select id="status">
      <option>Open</option>
      <option>Follow-up</option>
      <option>Resolved</option>
    </select>
    <textarea id="notes" rows="6">Concern:

Action Taken:</textarea>
    <button class="primary" onclick="saveLog()">Submit Log</button>
  </div>

  <!-- HISTORY -->
  <div class="card">
    <h3>History</h3>
    <input type="text" id="searchCustomer" placeholder="Search by Customer">
    <select id="filterCompany"></select>
    <input type="date" id="filterStartDate">
    <input type="date" id="filterEndDate">
    <button class="primary" onclick="loadLogs()">Search / Filter</button>
    <table>
      <thead>
        <tr>
          <th>Customer</th><th>Phone</th><th>Company</th>
          <th>Disposition</th><th>Status</th><th>Agent</th>
          <th>Date</th><th>Notes</th><th></th>
        </tr>
      </thead>
      <tbody id="logTable"></tbody>
    </table>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="card hidden">
    <h3>Admin Analytics</h3>
    <select id="adminCompanyFilter"></select>
    <input type="date" id="adminStartDate">
    <input type="date" id="adminEndDate">
    <button class="primary" onclick="loadAdminAnalytics()">Run Analytics</button>
    <hr>
    <div id="analytics"></div>
    <button class="primary" onclick="exportCSV()">Export CSV</button>
  </div>

</div>

<!-- NOTES MODAL -->
<div id="notesModal" class="modal">
  <div class="modal-content">
    <div id="modalText"></div>
    <button class="primary" onclick="closeModal()">Close</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>

// ================== REFS ==================
const modalText = document.getElementById('modalText');
const notesModal = document.getElementById('notesModal');
const toastEl = document.getElementById('toast');

const loginPage = document.getElementById('loginPage');
const app = document.getElementById('app');
const appHeader = document.getElementById('appHeader');
const userEmail = document.getElementById('userEmail');
const adminPanel = document.getElementById('adminPanel');

const customer = document.getElementById('customer');
const phone = document.getElementById('phone');
const refId = document.getElementById('refId');
const tool = document.getElementById('tool');
const company = document.getElementById('company');
const disposition = document.getElementById('disposition');
const status = document.getElementById('status');
const notes = document.getElementById('notes');

const searchCustomer = document.getElementById('searchCustomer');
const filterCompany = document.getElementById('filterCompany');
const filterStartDate = document.getElementById('filterStartDate');
const filterEndDate = document.getElementById('filterEndDate');
const logTable = document.getElementById('logTable');

const adminCompanyFilter = document.getElementById('adminCompanyFilter');
const adminStartDate = document.getElementById('adminStartDate');
const adminEndDate = document.getElementById('adminEndDate');
const analyticsEl = document.getElementById('analytics');

// ================== FIREBASE ==================
firebase.initializeApp({
  apiKey:"AIzaSyBEbq_d9nGXFLNdHaWICDfOzvQECC6yjOQ",
  authDomain:"call-logs-tool.firebaseapp.com",
  projectId:"call-logs-tool"
});
const auth = firebase.auth();
const db = firebase.firestore();
let isAdmin = false;

// ================== TOAST ==================
function showToast(msg,duration=2500){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'),duration);
}

// ================== LOGIN / LOGOUT ==================
function login(){
  const email = loginEmail.value.trim();
  const pwd = loginPassword.value;

  // Admin password-only login
  if(email === 'admin' && pwd === 'SLadmin@123'){
    isAdmin = true;
    loginPage.classList.add('hidden');
    app.classList.remove('hidden');
    appHeader.style.display='flex';
    userEmail.textContent = 'Admin';
    adminPanel.classList.remove('hidden');
    populateCompanyFilters();
    loadLogs();
    showToast('Admin login successful ✅');
    return;
  }

  // Regular user login
  if(!email.endsWith('@supplylogic.com')) return alert('Use company email');
  auth.signInWithEmailAndPassword(email,pwd).catch(e=>alert(e.message));
}

document.getElementById('logoutBtn')
  .addEventListener('click', ()=> auth.signOut());
  
// ================== AUTH STATE ==================
auth.onAuthStateChanged(u=>{
  if(u || isAdmin){
    showToast('Login successful ✅');
    loginPage.classList.add('hidden');
    app.classList.remove('hidden');
    appHeader.style.display='flex';
    userEmail.textContent = isAdmin ? 'Admin' : u.email;
    if(isAdmin) adminPanel.classList.remove('hidden');
    populateCompanyFilters();
    loadLogs();
  } else {
    loginPage.classList.remove('hidden');
    app.classList.add('hidden');
    appHeader.style.display='none';
  }
});
;
  
// ===== GLOBAL DATA =====
const companies={
  "Shopify":[
    "Bayada Wear","First Watch Shop","First Watch Swag","KOC","Learfield",
    "Raising Cane's Gear","Sevita","The Home Homer",
    "Dave & Buster's","Premise Health"
  ],
  "Marcom":[
    "American Airlines Credit Union","Applebee's","Brinker","Cash America",
    "Choice Hotels","Dave & Buster's / Main Event","Denny's",
    "Fogo de Chao","IHOP","Noodles & Company","Pei Wei",
    "Pizza Hut","Steak N Shake"
  ],
  "Marketing Bench":[
    "23 Restaurant Services","Aaron's, Inc.","Access Marketing Services","AdventHealth",
    "Agora Marketing Solutions, Inc.","Altium Packaging","AmeriHealth Caritas Services, LLC",
    "Arvest Bank","Baltimore Ravens","Baptist Memorial Health Care Corp",
    "BBI / Outback","Bonefish Grill","Brightview Senior Living","CACI","Cambria Properties",
    "CareFirst Management Company LLC","Carelon Behavioral Health","CarMax",
    "Carrabba's Italian Grill","Chicken Salad Chick","CIS-Knights of Columbus",
    "Compupay","Constellation Energy Generation LLC","Cumberland Pharmaceuticals",
    "D.R. Horton","Delaware North","DS Services of America, Inc.","Equistar Chemicals, LP",
    "Essential Brands dba/Kiddie Academy","First Busey Corporation","First Command",
    "First Watch Restaurants","Fleming's","Fraternal-Knights of Columbus","Georgia Power",
    "Hampton Inn & Suites - Hilton WW","HGI-Food & Beverage","Hilton Brands marKIT Orders",
    "Hilton F&B","HughesNet","Inventory/Coupa-Knights of Columbus",
    "James Hardie Bldg Products","Johns Manville","Keolis Transit America, Inc.",
    "Keplr Vision","KeyBank-WHS","La Quinta by Wyndham Hotels&Resorts",
    "Learfield Communications, LLC","LHC Group, Inc.","LYB Company Store","M&T Bank",
    "MAA Open Arms Program","Magellan Health","Magellan MFLC","Medstar Health",
    "Merry Maids","MileOne Autogroup","Modivcare","Natl. Mentor DBA Sevita",
    "NVR Marketing Services","Paycom Payroll Holdings","Piedmont Healthcare",
    "Pinch A Penny, Inc","Populus Fin. Group DBA ACE Cash Exp",
    "Preferred Hotel Group","Premise Health","Printpack","Qiagen",
    "SAIA Motor Freight Line, LLC","Sales Resource Center","Sick, Inc",
    "Southern Company Gas","Spanish site-Knights of Columbus",
    "Specialty Dental Brands","SSP America","Taub Family Selections",
    "Test Account Training","The Villages Operating Company","Transwestern",
    "Triad Advertising Corp","Trillium Health Resources","UMROI","Under Armour",
    "University of MD Medical System","Webb Mason Commercial",
    "Webb/Mason Company Store","Westmoor Mfg Co",
    "Wyndham Hotels&Resorts, Inc.","Yokohama Off Highway Tires"
  ]
};

// ===== GLOBAL FUNCTION =====
function loadCompanies(){
  const toolEl = document.getElementById('tool');
  const companyEl = document.getElementById('company');

  companyEl.innerHTML = '<option value="">Select Company</option>';

  const list = companies[toolEl.value] || [];

  list.forEach(c=>{
    const o = document.createElement('option');
    o.value = c;
    o.textContent = c;
    companyEl.appendChild(o);
  });
}


// Populate deduplicated filter companies
function populateCompanyFilters(){
  const allCompanies = Array.from(new Set([].concat(...Object.values(companies)))).sort();
  filterCompany.innerHTML='<option value="">All Companies</option>';
  adminCompanyFilter.innerHTML='<option value="">All Companies</option>';
  allCompanies.forEach(c=>{
    const o1 = document.createElement('option'); o1.value=o1.textContent=c; filterCompany.appendChild(o1);
    const o2 = document.createElement('option'); o2.value=o2.textContent=c; adminCompanyFilter.appendChild(o2);
  });
}

// ================== SAVE LOG ==================
function saveLog(){
  if(!customer.value || !tool.value || !company.value) return alert('Complete required fields');
  const statusVal = status.value;
  db.collection('logs').add({
    customer: customer.value,
    phone: phone.value||'',
    ref: refId.value||'',
    tool: tool.value,
    company: company.value,
    disposition: disposition.value,
    status: statusVal,
    notes: notes.value.trim(),
    agent: auth.currentUser.email,
    created: firebase.firestore.FieldValue.serverTimestamp(),
    resolvedAt: statusVal==='Resolved'?firebase.firestore.FieldValue.serverTimestamp():null,
    createdDay: new Date().toISOString().slice(0,10),
    createdMonth: new Date().toISOString().slice(0,7)
  }).then(()=>{
    customer.value=''; phone.value=''; refId.value=''; notes.value="Concern:\n\nAction Taken:";
    showToast('✅ Log saved');
    loadLogs();
  }).catch(e=>alert(e.message));
}

// ================== LOAD LOGS ==================
function loadLogs(){
  logTable.innerHTML='';
  let start = filterStartDate.value ? new Date(filterStartDate.value) : null;
  let end = filterEndDate.value ? new Date(filterEndDate.value) : null;

  let q = db.collection('logs').orderBy('created', 'desc');

  if(filterCompany.value) q = q.where('company','==',filterCompany.value);
  if(start) q = q.where('created', '>=', firebase.firestore.Timestamp.fromDate(start));
  if(end) q = q.where('created', '<=', firebase.firestore.Timestamp.fromDate(end));

  q.get().then(s=>{
    logTable.innerHTML = '';
    if(s.empty){
      logTable.innerHTML = '<tr><td colspan="9" style="text-align:center;">No logs found</td></tr>';
      return;
    }
    s.forEach(d=>{
      const l = d.data();
      if(searchCustomer.value && !l.customer.toLowerCase().includes(searchCustomer.value.toLowerCase())) return;
      const tr = document.createElement('tr');
      tr.innerHTML=`
<td>${l.customer}</td>
<td>${l.phone}</td>
<td>${l.company}</td>
<td>${l.disposition}</td>
<td>${l.status}</td>
<td>${l.agent}</td>
<td>${l.created?.toDate().toLocaleString()||''}</td>
<td><button onclick="viewNotes('${d.id}')">View</button></td>
<td>${isAdmin?`<button onclick="deleteLog('${d.id}')">Delete</button>`:''}</td>`;
      logTable.appendChild(tr);
    });
  });
}


// ================== NOTES MODAL ==================
function viewNotes(id){
  db.collection('logs').doc(id).get().then(doc=>{
    const txt = (doc.data().notes||'').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    modalText.innerHTML = txt;
    notesModal.style.display='flex';
  });
}
function closeModal(){ notesModal.style.display='none'; }

// ================== DELETE LOG ==================
function deleteLog(id){
  if(confirm('Delete this log?')) db.collection('logs').doc(id).delete().then(loadLogs);
}

// ================== ADMIN ANALYTICS ==================
function loadAdminAnalytics(){
  analyticsEl.innerHTML='Loading...';
  let q = db.collection('logs');
  if(adminCompanyFilter.value) q = q.where('company','==',adminCompanyFilter.value);

  // Filter by timestamp
  if(adminStartDate.value){
    let start = new Date(adminStartDate.value);
    q = q.where('created', '>=', firebase.firestore.Timestamp.fromDate(start));
  }
  if(adminEndDate.value){
    let end = new Date(adminEndDate.value);
    end.setHours(23,59,59,999); // include entire day
    q = q.where('created', '<=', firebase.firestore.Timestamp.fromDate(end));
  }

  q.get().then(s=>{
    let total=0, resolved=0;
    let agentMap={};

    s.forEach(d=>{
      total++;
      const data = d.data();
      if(data.status==='Resolved') resolved++;
      agentMap[data.agent] = (agentMap[data.agent]||0)+1;
    });

    // Leaderboard
    let leaderboardHTML = '<b>Leaderboard (Logs per Agent)</b><br>';
    const sortedAgents = Object.entries(agentMap).sort((a,b)=>b[1]-a[1]);
    sortedAgents.forEach(([agent,count])=>{
      leaderboardHTML += `${agent}: ${count}<br>`;
    });

    analyticsEl.innerHTML = `<b>Total Logs:</b> ${total}<br><b>Resolved:</b> ${resolved}<br>${leaderboardHTML}`;
  });
}

// ================== EXPORT CSV ==================
function exportCSV(){
  let q = db.collection('logs');
  if(adminCompanyFilter.value) q = q.where('company','==',adminCompanyFilter.value);

  // Filter by start date
  if(adminStartDate.value){
    let start = new Date(adminStartDate.value);
    start.setHours(0,0,0,0);
    q = q.where('created', '>=', firebase.firestore.Timestamp.fromDate(start));
  }

  // Filter by end date
  if(adminEndDate.value){
    let end = new Date(adminEndDate.value);
    end.setHours(23,59,59,999);
    q = q.where('created', '<=', firebase.firestore.Timestamp.fromDate(end));
  }

  q.get().then(snapshot=>{
    if(snapshot.empty){
      return alert('No logs found for export.');
    }

    let totalLogs = 0;
    let resolvedLogs = 0;
    let slaCount = 0;
    const agentMap = {};
    const companyMap = {};
    const dispositionMap = {};
    const logsPerDay = {};

    // Process all logs
    const logRows = [];
    snapshot.forEach(doc=>{
      const l = doc.data();
      totalLogs++;

      if(l.status === 'Resolved') resolvedLogs++;

      // SLA: resolved within 24h
      if(l.status === 'Resolved' && l.resolvedAt && l.created){
        const createdTime = l.created.toDate();
        const resolvedTime = l.resolvedAt.toDate();
        if((resolvedTime - createdTime) <= 24*60*60*1000) slaCount++;
      }

      // Analytics maps
      agentMap[l.agent] = (agentMap[l.agent] || 0) + 1;
      companyMap[l.company] = (companyMap[l.company] || 0) + 1;
      dispositionMap[l.disposition] = (dispositionMap[l.disposition] || 0) + 1;

      const day = l.created?.toDate().toISOString().slice(0,10) || 'Unknown';
      logsPerDay[day] = (logsPerDay[day] || 0) + 1;

      // Prepare CSV row
      logRows.push([
        l.customer,
        l.phone,
        l.company,
        l.disposition,
        l.status,
        l.agent,
        l.created?.toDate().toLocaleString() || '',
        (l.notes||'').replace(/\n/g,' ')
      ]);
    });

    const resolvedPercent = ((resolvedLogs / totalLogs) * 100).toFixed(1);
    const slaPercent = ((slaCount / totalLogs) * 100).toFixed(1);

    const mostCompany = Object.entries(companyMap).sort((a,b)=>b[1]-a[1])[0] || ['-',0];
    const mostDisposition = Object.entries(dispositionMap).sort((a,b)=>b[1]-a[1])[0] || ['-',0];

    // Build CSV
    let csv = `Analytics Summary\n`;
    csv += `Total Logs,${totalLogs}\n`;
    csv += `Resolved,${resolvedLogs}\n`;
    csv += `Resolved %,${resolvedPercent}%\n`;
    csv += `SLA (Resolved within 24h),${slaPercent}%\n`;
    csv += `Most Used Company,${mostCompany[0]} (${mostCompany[1]})\n`;
    csv += `Most Used Disposition,${mostDisposition[0]} (${mostDisposition[1]})\n`;
    csv += `Logs per Day\nDate,Count\n`;
    Object.entries(logsPerDay).sort((a,b)=>new Date(a[0])-new Date(b[0]))
      .forEach(([day,count]) => { csv += `${day},${count}\n`; });

    csv += `\nLogs Data\nCustomer,Phone,Company,Disposition,Status,Agent,Date,Notes\n`;
    logRows.forEach(r => {
      csv += `"${r.join('","')}"\n`;
    });

    // Download
    const blob = new Blob([csv], {type: 'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'logs_export.csv';
    a.click();

    showToast('CSV exported ✅');
  });
}


// ================== ENTER KEY SUBMIT ==================
document.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    if(!loginPage.classList.contains('hidden')) login();
    else if(document.activeElement.tagName!=='TEXTAREA') saveLog();
  }
});
</script>
</body>
</html>








